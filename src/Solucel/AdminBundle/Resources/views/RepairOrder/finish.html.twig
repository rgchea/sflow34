{% extends 'SolucelAdminBundle::layout.html.twig' %}

{% block breadcrumb %}
    {{ parent() }}
    
    {% endblock %}

{% block title %}
    Entrega
    
{% endblock %}

{% block javascripts %}
    {{ parent() }}

<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <link rel="stylesheet" href="/resources/demos/style.css">
  <style>
    label, input { display:block; }
    input.text { margin-bottom:12px; width:95%; padding: .4em; }
    fieldset { padding:0; border:0; margin-top:25px; }
    h1 { font-size: 1.2em; margin: .6em 0; }
    div#users-contain { width: 350px; margin: 20px 0; }
    div#users-contain table { margin: 1em 0; border-collapse: collapse; width: 100%; }
    div#users-contain table td, div#users-contain table th { border: 1px solid #eee; padding: .6em 10px; text-align: left; }
    .ui-dialog .ui-state-error { padding: .3em; }
    .validateTips { border: 1px solid transparent; padding: 0.3em; }
  </style>    

    
    <script src="{{ asset('bundles/pizotearkadmin/js/plugin/datatables/jquery.dataTables-cust.js') }}"></script>
    <script src="{{ asset('bundles/pizotearkadmin/js/plugin/datatables/ColReorder.min.js') }}"></script>
    <script src="{{ asset('bundles/pizotearkadmin/js/plugin/datatables/FixedColumns.min.js') }}"></script>
    <script src="{{ asset('bundles/pizotearkadmin/js/plugin/datatables/ColVis.min.js') }}"></script>
    <script src="{{ asset('bundles/pizotearkadmin/js/plugin/datatables/ZeroClipboard.js') }}"></script>
    <script src="{{ asset('bundles/pizotearkadmin/js/plugin/datatables/media/js/TableTools.min.js') }}"></script>
    <script src="{{ asset('bundles/pizotearkadmin/js/plugin/datatables/DT_bootstrap.js') }}"></script>

{% endblock %}


{% block body -%}
{{ parent() }}

<script>
	$('#pizote_spinner').show();
</script>
<div class="row">
    <div class="col-xs-12 col-sm-7 col-md-7 col-lg-4">

    </div>

</div>

<div class="jarviswidget jarviswidget-color-darken" id="wid-id-0" data-widget-editbutton="false">
    <header>
        <h2> Ordenes para Entregar</h2>
    </header>

    <!-- widget div-->
    <div>


		<form id="filterForm" action="{{path('solucel_admin_repairorder_finish')}}" method="POST">
			<!-- widget edit box -->
			<div class="jarviswidget-editbox">
				<!-- This area used as dropdown edit box -->
            

            	<input type="hidden" name="filter" value="true" />
	            <fieldset>
					<table width="90%">
						<tbody>
							<tr>
								<td>
									<label for="select_operator">Operador:</label><br />
									<select id="select_operator" name="select_operator">
										
										{# evaluates to true if the foo variable is iterable #}
										{% if operators is iterable %}
											<option value="0">Todos</option>
									   		{% for operator in operators %}
										   		{% set selected = operator.id == select_operator ? ' selected="selected" ' : ''%}
										        	<option value="{{operator.id}}" {{selected}}>{{ operator.name }}</option>
										    	{% endfor %}										
										{% else %}
										    {# users is probably a single object #}
										    <option value="{{operators.id}}">{{ operators.name }}</option>
										{% endif %}										
																				
									</select>
									
								</td>
								<td>
									<label for="select_agency">Agencia:</label><br />
									<select id="select_agency" name="select_agency"  >
										<option value="0">Todos</option>
									   {% for agency in agencies%}
											{% set selected = agency.id == select_agency ? ' selected="selected" ' : ''%}	
									        <option value="{{agency.id}}" {{selected}}>{{ agency.name }}</option>
									    {% endfor %}										
									</select>
									
								</td>								
								<td>
									<label for="select_service_center">Centro de Servicio:</label><br />
									<select id="select_service_center" name="select_service_center" >
										
										{# evaluates to true if the foo variable is iterable #}
										{% if service_centers is iterable %}
											<option value="0">Todos</option>
									   		{% for service_center in service_centers %}
										   		{% set selected = service_center.id == select_service_center ? ' selected="selected" ' : ''%}
										        	<option value="{{service_center.id}}" {{selected}}>{{ service_center.name }}</option>
										    	{% endfor %}										
										{% else %}
										    {# users is probably a single object #}
										    <option value="{{service_centers.id}}">{{ service_centers.name }}</option>
										{% endif %}										
										
										
									</select>
									
								</td>
																					
								<td>
									<label for="select_brand">Marca:</label><br />
									<select id="select_brand" name="select_brand" >
										
										{# evaluates to true if the foo variable is iterable #}
										{% if brands is iterable %}
											<option value="0">Todos</option>
									   		{% for brand in brands %}
										   		{% set selected = brand.id == select_brand ? ' selected="selected" ' : ''%}
										        	<option value="{{brand.id}}" {{selected}}>{{ brand.name }}</option>
										    	{% endfor %}										
										{% else %}
										    {# brands is probably a single object #}
										    <option value="{{brands.id}}">{{ brands.name }}</option>
										{% endif %}										
										
										
									</select>
									
								</td>
																														
							</tr>
							<tr>
								<td>
									<label for="created_from">Ingresada del:</label><br />
									<input readonly="readonly" id="created_from" name="created_from" type="text" class="form-control" value="{{filter_created_from}}" />									
								</td>								
								<td>
									<label for="created_to">Ingresada al:</label><br />
									<input readonly="readonly" id="created_to" name="created_to" type="text" class="form-control" value="{{filter_created_to}}" />									
								</td>
								<td>
									<label for="filter_dates">Aplicar Fechas:</label><br />
									<input id="filter_dates" name="filter_dates" type="checkbox" class="form-control" {{ filter_dates == 1 ? 'checked="checked"' : ''  }}  />									
								</td>									
							</tr>
							<tr>
								<td colspan="4" align="left">
									<button class="btn btn-primary" onclick="$('#pizote_spinner').show();">
									<i class="fa fa-search"></i>
										Filtrar
									</button>									
								</td>
							</tr>
							
						</tbody>
					</table>

				</fieldset>

				<br />
				<div id="buttonFinishBulk" style="display: none">
					<button type="button" class="btn btn-primary" onclick="myFinishBulk()">
						Finalizar BULK
					</button>

				</div>

			</div>
				<!-- end widget edit box -->

				<!-- widget content -->
				<div class="widget-body no-padding">
					<div class="widget-body-toolbar">

					</div>

					<table id="dt_basic" class="table table-striped table-bordered table-hover" >
						<thead>
							<tr>
								<th>Boleta #</th>
								<th>Correlativo #</th>
								<th>Operador</th>
								<th>Agencia</th>
								<th>Centro de Servicio</th>
								<th>Técnico</th>
								<th>Marca Dispositivo</th>
								<th>Ingresada</th>
								<th>Estado</th>
								<th width="150" class="no-sort" >Acciones</th>
								<th width="150" class="no-sort" >Finalizar</th>
								<th width="150" class="no-sort" >Finalizar Bulk &nbsp;<input type="checkbox" name="finish_all" id="finish_all" onclick="checkAll(this.checked)"></th>
							</tr>
						</thead>
						<tbody>
						{% for entity in entities %}

							<tr>
								<td>{{ entity.ticket_number }}</td>
								<td>{{ entity.id }}</td>
								<td>{{ entity.operator }}</td>
								<td>{{ entity.agency }}</td>
								<td>{{ entity.service_center }}</td>
								<td>{{ entity.assigned_to }}</td>
								<td>{{ entity.brand }}</td>
								<td>{{ entity.entry_date|date("d/m/Y") }}</td>
								<td>{{ entity.repair_status }}</td>
								<td align="right">

									<a target="_blank" href="{{ path('solucel_admin_repairorder_print', {'id': entity.id }) }}" title="Imprimir" >
										<div class="btn btn-sm btn-primary">
											<i class="fa fa-fw fa-print"></i>
										</div>
									</a>

									<a href="{{ path('solucel_admin_repairorder_show', {'id': entity.id }) }}" title="Ver">
										<div class="btn btn-sm btn-primary">
											<span class="fa fa-search"></span>
										</div>
									</a>

								</td>
								<td>
									<a onclick="orderDone('{{entity.id}}', '{{ entity.brand }}')" class="btn btn-success" type="button">Entregada/Finalizada</a>
								</td>
								<td> <input type="checkbox" name="finish[{{ entity.id }}]" id="finish_{{entity.id}}" onclick="$('#buttonFinishBulk').show();"></td>

							</tr>
						{% endfor %}
						</tbody>
					</table>


				</div>
				<!-- end widget content -->

		</form>

    </div>
    <!-- end widget div -->
    
	<div id="dialog-form" title="Guía de Salida" style="z-index: 9999">
	 
	  <form id="form_guide">
	    <fieldset>
	      <label for="guide_out">Guía de Salida</label>
	      <input type="text" name="guide_out" id="guide_out" required=""class="text ui-widget-content ui-corner-all">
	      <!-- Allow form submission with keyboard without duplicating the dialog button -->
	      <input type="submit" tabindex="-1" style="position:absolute; top:-1000px">
	    </fieldset>

	  </form>
	</div>

	<div id="dialog-form-bulk" title="Guía de Salida" style="z-index: 9999">

		<form id="form_guide_bulk">
			<fieldset>
				<label for="guide_out_bulk">Guía de Salida</label>
				<input type="text" name="guide_out_bulk" id="guide_out_bulk" required=""class="text ui-widget-content ui-corner-all">
				<!-- Allow form submission with keyboard without duplicating the dialog button -->
				<input type="submit" tabindex="-1" style="position:absolute; top:-1000px">
			</fieldset>

		</form>
	</div>

	{#
	<div id="dialog-form-moto" title="Guía de Salida" style="z-index: 9999">

	  <form id="form_guide">
	    <fieldset>

			<div class="form-group col-md-6">
		      <label for="guide_out_moto">Guía de Salida</label>
		      <input type="text" name="guide_out_moto" id="guide_out_moto" required=""class="text ui-widget-content ui-corner-all">
		      <!-- Allow form submission with keyboard without duplicating the dialog button -->
		      <input type="submit" tabindex="-1" style="position:absolute; top:-1000px">
			</div>

			<div class="form-group col-md-6">
		      <label for="device_imei2">IMEI 2 IN</label>
		      <input type="text" name="device_imei2" id="device_imei2" required=""class="text ui-widget-content ui-corner-all">
			</div>

			<div class="clearfix"></div>


			<div class="form-group col-md-6">
		      <label for="device_imei_out">IMEI OUT</label>
		      <input type="text" name="device_imei_out" id="device_imei_out" required=""class="text ui-widget-content ui-corner-all">
			</div>


			<div class="form-group col-md-6">
		      <label for="device_imei2_out">IMEI 2 OUT</label>
		      <input type="text" name="device_imei2_out" id="device_imei2_out" required=""class="text ui-widget-content ui-corner-all">
			</div>

			<div class="clearfix"></div>

			<div class="form-group col-md-6">
		      <label for="device_msn_out">SERIAL NUMBER OUT</label>
		      <input type="text" name="device_msn_out" id="device_msn_out" required=""class="text ui-widget-content ui-corner-all">
			</div>



	    </fieldset>




	  </form>
	</div>
	#}

	
	  
</div>    


<script type="text/javascript" language="JavaScript">
	
	
	$( document ).ready(function() {
		
		agencyID = '{{select_agency}}';
		
		changeAgency();
		
		$( "#select_operator" ).change(function() {
		  changeAgency();
		});			
		
		$("#done").remove();
		$('#pizote_spinner').hide();	
		
		
	});
	
	var globalOrderID = 0;

	//DIALOGO PARA ENTREGA BULK
	dialogBulk = $( "#dialog-form-bulk" ).dialog({
		autoOpen: false,
		height: 400,
		width: 350,
		modal: true,
		buttons: {
			"Aceptar": submitBulk,
			Cancel: function() {
				dialog.dialog( "close" );
			}
		},
		close: function() {
			form[ 0 ].reset();
			//allFields.removeClass( "ui-state-error" );
		}
	});

	form = dialogBulk.find( "form" ).on( "submit", function( event ) {
		event.preventDefault();
		submitBulk();
	});


	function submitBulk(){
		var valid = true;
		guide = $("#guide_out_bulk").val();
		if(guide.trim() != ""){
			$("#filterForm").append('<input id="guide_out_bulk" type="hidden" name="guide_out_bulk" value="'+guide+'" />');
			$("#filterForm").submit();
		}
		else{
			alert("Debe ingresar guía de salida");
			return false;
		}

		$('#pizote_spinner').show();

	}

	///DIALOGO PARA ENTREGA NORMAL
 	dialog = $( "#dialog-form" ).dialog({
      autoOpen: false,
      height: 400,
      width: 350,
      modal: true,
      buttons: {
        "Aceptar": addGuide,
        Cancel: function() {
          dialog.dialog( "close" );
        }
      },
      close: function() {
        form[ 0 ].reset();
        //allFields.removeClass( "ui-state-error" );
      }
    });		
    
	form = dialog.find( "form" ).on( "submit", function( event ) {
      event.preventDefault();
      addGuide();
    });	    
    
    /*
 	dialogMoto = $( "#dialog-form-moto" ).dialog({
      autoOpen: false,
      height: 600,
      width: 720,
      modal: true,
      buttons: {
        "Aceptar": addGuideMoto,
        Cancel: function() {
          dialog.dialog( "close" );
        }
      },
      close: function() {
        form[ 0 ].reset();
        //allFields.removeClass( "ui-state-error" );
      }
    });		
    
	form = dialogMoto.find( "form" ).on( "submit", function( event ) {
      event.preventDefault();
      addGuideMoto();
    });
    */
    
    function addGuide() {
      var valid = true;
      guide = $("#guide_out").val();
      if(guide.trim() != ""){
      	$("#filterForm").append('<input id="done" type="hidden" name="done" value="'+globalOrderID+'" />');
      	$("#filterForm").append('<input id="guide_out" type="hidden" name="guide_out" value="'+guide+'" />');
      	$("#filterForm").submit();
      }
      else{
      	alert("Debe ingresar guía de salida");
      	return false;
      }
      
 		$('#pizote_spinner').show();	
 		
      //return valid;
    }    
	
	/*
    function addGuideMoto() {
      var valid = true;
      guide = $("#guide_out_moto").val();
      if(guide.trim() != ""){
      	$("#filterForm").append('<input id="done" type="hidden" name="done" value="'+globalOrderID+'" />');
      	$("#filterForm").append('<input id="guide_out_moto" type="hidden" name="guide_out_moto" value="'+guide+'" />');
      }
      else{
      	alert("Debe ingresar guía de salida");
      	return false;
      }
      
      guide = $("#device_imei2").val(); 
      if(guide.trim() != ""){
      	$("#filterForm").append('<input id="done" type="hidden" name="done" value="'+globalOrderID+'" />');
      	$("#filterForm").append('<input id="device_imei2" type="hidden" name="device_imei2" value="'+guide+'" />');
      }
      else{
      	alert("Debe ingresar IMEI 2 IN");
      	return false;
      }      

      
      guide = $("#device_imei_out").val(); 
      if(guide.trim() != ""){
      	$("#filterForm").append('<input id="done" type="hidden" name="done" value="'+globalOrderID+'" />');
      	$("#filterForm").append('<input id="device_imei_out" type="hidden" name="device_imei_out" value="'+guide+'" />');
      	
      }
      else{
      	alert("Debe ingresar IMEI OUT");
      	return false;
      }	


      guide = $("#device_imei2_out").val(); 
      if(guide.trim() != ""){
      	$("#filterForm").append('<input id="done" type="hidden" name="done" value="'+globalOrderID+'" />');
      	$("#filterForm").append('<input id="device_imei2_out" type="hidden" name="device_imei2_out" value="'+guide+'" />');
      	
      }
      else{
      	alert("Debe ingresar IMEI 2 OUT");
      	return false;
      }	

      guide = $("#device_msn_out").val(); 
      if(guide.trim() != ""){
      	$("#filterForm").append('<input id="done" type="hidden" name="done" value="'+globalOrderID+'" />');
      	$("#filterForm").append('<input id="device_msn_out" type="hidden" name="device_msn_out" value="'+guide+'" />');
      	
      }
      else{
      	alert("Debe ingresar SERIAL NUMBER OUT");
      	return false;
      }	
      
      $("#filterForm").append('<input id="typeMoto" type="hidden" name="typeMoto" value="true" />');
      
		$("#filterForm").submit();      

 		$('#pizote_spinner').show();	
 		
      //return valid;
    }
    */

	function myFinishBulk(){
		dialogBulk.dialog( "open" );
		$("#filterForm").append('<input id="finishBulk" type="hidden" name="finishBulk" value="true" />');
	}

	
	function orderDone(orderID, brand){
		
		globalOrderID = orderID;
		
		/*
		if(brand == "Motorola"){
			dialogMoto.dialog( "open" );
		}
		else{
			dialog.dialog( "open" );
		}
		*/
		
		dialog.dialog( "open" );
		
		console.log(orderID);
		
		
	}	
		
	function changeAgency(){
		$('#pizote_spinner').show();
		
		if($("#select_operator").val() != 0){
			$.ajax({
				type:"POST",
				dataType:"json",
				async: false,
				url:"{{ path('solucel_admin_repairorder_agency') }}",
				data:"operator_id="+$( "#select_operator" ).val(),
				success:function(data){
					
					
					if (!isEmpty(data)){
						
						var items = [];
							items.push( "<option value='0'>Todos</option>" );
						  $.each( data, function( key, val ) {
						  	selected = key == agencyID ? 'selected="selected"' : '';
						    items.push( "<option "+selected+" value='" + key + "'>" + val + "</option>" );
						  });
											
						$("#select_agency").html(items);	
						
					}
					else{
						$("#select_agency").html("<option value='0'>Todos</option>");
					}
					
					
					
				}
			});	 
			
		}
		
		$('#pizote_spinner').hide();
  		
	}	
	
	
	function isEmpty(obj) {
	    return Object.keys(obj).length === 0;
	}

	function checkAll(isChecked){

    	console.log(isChecked);
		{% for entity in entities %}
			$("#finish_{{ entity.id }}").click();
		{% endfor %}

		if(isChecked){
			$("#buttonFinishBulk").show();
		}
		else{
			$("#buttonFinishBulk").hide();
			$("#finishBulk").remove();
		}



	}

	
</script>

{% endblock %}


{% block extrascripts %}

	$("#created_from").datepicker();
	$("#created_to").datepicker();

    $('#dt_basic').dataTable({
		iDisplayLength: -1,
	    "sPaginationType" : "bootstrap_full",
	    "aaSorting": [[ 0, "asc" ]],
		"columnDefs": [ {
		"targets": 'no-sort',
		"orderable": false,
		} ],
        "language": {
            "url": "{{ asset('bundles/pizotearkadmin/js/plugin/datatables/dataTables.spanish.lang') }}"
        }	    
    });

    $(document).on('click', '.btn-delete', function(e){
	    e.preventDefault();
	
	    var url = $(this).attr('href'); 
	    var c = confirm('Está seguro?');
	
	    if(c){
	    	window.location = url;
	    }else{
	    	return false;
	    }


    });
    

{% endblock %}