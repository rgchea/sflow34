<?php

namespace Solucel\AdminBundle\Repository;

use Doctrine\ORM\EntityRepository;
use Symfony\Component\HttpFoundation\Session\Session;

/**
 * RepairOrderRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class RepairOrderRepository extends \Doctrine\ORM\EntityRepository
{

	public function checkEntryType($code, $type){


	    //RE INCIDENCIA

        //RE INGRESO
		if($type == 1){
			$sql = "	SELECT 	ro.id, ro.device_imei, DATE(ro.entry_date) fecha_entrada, 
	                            DATE_FORMAT(ro.device_purchase_date, '%d/%m/%Y') device_purchase_date, rof.fix_detail
						FROM	repair_order ro
						    LEFT JOIN repair_order_fix rof ON (rof.repair_order_id = ro.id)
						WHERE	ro.device_imei = '{$code}'
						AND		ro.enabled = 1
						";
			//LIMIT 1
			
		}//phone
		else{
			$sql = "	SELECT 	ro.id, ro.device_imei, DATE(ro.entry_date) fecha_entrada, 
	                            DATE_FORMAT(ro.device_purchase_date, '%d/%m/%Y') device_purchase_date, rof.fix_detail
						FROM	repair_order ro
						    LEFT JOIN repair_order_fix rof ON (rof.repair_order_id = ro.id)
						WHERE	ro.device_code_fab = '{$code}'
						AND		ro.enabled = 1
						";
			//LIMIT 1
			
		}

		$strFilterReincidencia = " AND DATE(ro.entry_date) > (NOW() - INTERVAL 90 DAY)";
		$stmt = $this->getEntityManager()->getConnection()->prepare($sql.$strFilterReincidencia);
	    $stmt->execute();
	    $executeReincidencia = $stmt->fetchAll();
		$returnReincidencia = empty($executeReincidencia) ? 1 : 3;

        $strFilterReingreso = " AND DATE(ro.entry_date) < (NOW() - INTERVAL 90 DAY)";
        $stmt = $this->getEntityManager()->getConnection()->prepare($sql.$strFilterReingreso);
        $stmt->execute();
        $executeReingreso = $stmt->fetchAll();
        $returnReingreso = empty($executeReingreso) ? 1 : 2;

		//1 - ingreso
		//2 - re ingreso
        //3 - re incidencia
		$returnTMP = array();
//		var_dump($returnReingreso);
//        var_dump($returnReincidencia);die;

		if($returnReingreso == 1 && $returnReincidencia == 1){
			$returnTMP["result"] = 1;
			//$returnTMP["date"] = $return[0]["fecha_entrada"];
		}
		else{
			$returnTMP["result"] = $returnReincidencia == 3 ? 3 : 2;

            if($returnTMP["result"] == 3){
                $execute = $executeReincidencia;
            }
            else{
                $execute = $executeReingreso;
            }
			//$returnTMP["date"] = $execute[0]["fecha_entrada"];
            $returnTMP["count"] = count($execute);
            $returnTMP["imei"] = $execute[0]["device_imei"];
            $returnTMP["id"] = $execute[0]["id"];
            $returnTMP["device_purchase_date"] = $execute[0]["device_purchase_date"];

            //862654035419168
            $returnTMP["history"] = array();

			foreach ($execute as $key => $value){
			    $id = $value["id"];
                $entryDate = $value["fecha_entrada"];
                $returnTMP["date"] = $entryDate;

                ////DEFECTOS
                $sqlHistory = " SELECT 	dd.name
                                FROM	repair_order_device_defect rdd
                                    INNER JOIN device_defect dd ON(rdd.device_defect_id = dd.id)
                                WHERE	rdd.repair_order_id	= {$id}";

                $stmt = $this->getEntityManager()->getConnection()->prepare($sqlHistory);
                $stmt->execute();

                $executeHistory = $stmt->fetchAll();

                $returnTMP["history"][$id] = array();
                $returnTMP["history"][$id]["date"] = $entryDate;
                $returnTMP["history"][$id]["fix_detail"] = $value["fix_detail"];
                $returnTMP["history"][$id]["defects"] = "N/A";
                $returnTMP["history"][$id]["replacements"] = "N/A";

                if(!empty($executeHistory)){
                    $strDefects = "";
                    foreach ($executeHistory as $key => $defect) {
                        $strDefects .= $strDefects == "" ? $defect["name"] : " - ".$defect["name"];
                    }
                    $returnTMP["history"][$id]["defects"] = $strDefects;
                }

                //REPUESTOS
                $sqlHistory = " SELECT 	dr.name
                                FROM	repair_order_device_replacement rdr
                                    INNER JOIN device_replacement dr
                                WHERE	rdr.repair_order_id	= {$id}";

                $stmt = $this->getEntityManager()->getConnection()->prepare($sqlHistory);
                $stmt->execute();

                $executeHistory = $stmt->fetchAll();

                if(!empty($executeHistory)){
                    $strReplacements = "";
                    foreach ($executeHistory as $key => $replacement) {
                        $strReplacements .= $strReplacements == "" ? $replacement["name"] : " - ".$replacement["name"];
                    }
                    $returnTMP["history"][$id]["replacements"] = $strReplacements;
                }
            }
		}




		////
        /// history
//        print "<pre>";
//        var_dump($returnTMP);die;

		return 	$returnTMP;
		
	}		
	
	
	public function checkWarranty($orderID){

		$sql = "	SELECT 	device_purchase_date, humidity
					FROM	repair_order
					WHERE	id = '{$orderID}'
					AND		enabled = 1";
			
					 
		   
		$stmt = $this->getEntityManager()->getConnection()->prepare($sql);
	    $stmt->execute();
		
	    $execute = $stmt->fetchAll();
		
		/*
		print "<pre>";
		var_dump($execute);*/	
			   
		
		//die();
		$hasHumidity = $execute[0]["humidity"];
		$purchaseDate = $execute[0]["device_purchase_date"];
		//$purchaseDate = "2017-01-17";
		
		$purchaseDatePlusYear = date('Y-m-d', strtotime($purchaseDate. ' + 365 days'));
		$datetime1 = date_create($purchaseDatePlusYear);
		$datetime2 = date_create('now');
		$interval = date_diff($datetime1, $datetime2);
		//var_dump($interval);die;
		$days = $interval->format('%R%a');//dias
		
		
		//var_dump(intval($days));die;
		 
		
		
		$return = $days > 1 ? 0 : 1;
		//con el id que está guardado en base de datos 1,2
		//1 - con garantia
		//0 - sin garantia
		
		//humedad
		if(intval($return) == 1){
			if(intval($hasHumidity) == 1){
				$return = 0;
			}
		} 
		
		//print $return;die;
		
		return $return;		
		
		


		
	}		
	
	
	public function filterOrders($request){

		/*
		print "<pre>";
		var_dump($request);die;
		
		 * */

		$strFilter  = "";
		
		if(isset($request["filter_dates"]) && $request["filter_dates"] != 0){
		$strFilter = " AND (DATE(repairo.entry_date) >= '".$request["filter_created_from"]. "'  AND DATE(repairo.entry_date) <= '".$request["filter_created_to"]."')";
		}
		if(isset($request["filter_operator"]) && $request["filter_operator"] != 0){
			$strFilter .= " AND operator.id = ".$request["filter_operator"];
		}
		
		if(isset($request["filter_brand"]) && $request["filter_brand"] != 0){
			$strFilter .= " AND brand.id = ".$request["filter_brand"];
		}
		
		if(isset($request["filter_agency"]) && $request["filter_agency"] != 0){
			$strFilter .= " AND agency.id = ".$request["filter_agency"];
		}
		if(isset($request["filter_service_center"]) && $request["filter_service_center"] != 0){
			$strFilter .= " AND service.id = ".$request["filter_service_center"];
		}						
		if(isset($request["filter_status"]) && $request["filter_status"] != 0){
			$strFilter .= " AND repairo.repair_status_id = ".$request["filter_status"];
		}
		if(isset($request["filter_assign"])){
			$strFilter .= " AND rs.name = 'INGRESADO' ";
		}

        if(isset($request["filter_ready_to_assign"])){
            $readyToAssign = intval($request["filter_ready_to_assign"]);
            $strFilter .= " AND repairo.ready_to_assign = {$readyToAssign} ";
        }
			
		//filtro para ordenes FINALIZADAS
		if(isset($request["filter_finish"])){
			
			$strFilter .= " AND rs.name IN ('CAMBIO POR GARANTIA', 'FINALIZADO', 'NO REPARADO/NO CONFIRMADO', 'IRREPARABLE') ";//
		}		
		
		//NEW FILTERS
		if(isset($request["filter_client_name"]) && trim($request["filter_client_name"]) != ""){
			$strFilter .= " AND ( cl.name LIKE '%".$request["filter_client_name"] ."%'";
			$strFilter .= " OR  cl.last_name LIKE '%".$request["filter_client_name"] ."%'";
			$strFilter .= " OR  CONCAT(cl.name, ' ', cl.last_name) LIKE '%".$request["filter_client_name"] ."%'";
			$strFilter .= " OR cl.dpi LIKE '%".$request["filter_client_name"] ."%'";
			$strFilter .= " OR  cl.nit LIKE '%".$request["filter_client_name"] ."%' )";
		}

		if(isset($request["filter_phone_number"]) && trim($request["filter_phone_number"]) != ""){
			//$strFilter .= " AND repairo.phone_number = ".$request["filter_phone_number"];
			$strFilter .= " AND repairo.phone_number LIKE '%".$request["filter_phone_number"] ."%'";
		}		
        
		
		if(isset($request["filter_imei"]) && trim($request["filter_imei"]) != ""){
			//$strFilter .= " AND repairo.device_imei = ".$request["filter_imei"];
			$strFilter .= " AND repairo.device_imei LIKE '%".$request["filter_imei"] ."%' ";
		}
		
		if(isset($request["filter_id"]) && $request["filter_id"] != ""){
			//$strFilter .= " AND repairo.id = ".intval($request["filter_id"]);
			$strFilter .= " AND repairo.ticket_number = '".$request["filter_id"]."'";
		}
						
		//default ordenes en estado ingreso
		//ros.repair_status_id order_status
		//rs.name repair_status,
		$sql = "	SELECT 	DISTINCT(repairo.id), repairo.created_at, repairo.entry_date,  
	                        repairo.ticket_number, repairo.ready_to_assign, repairo.paperwork_comment,
							operator.name operator, agency.name agency, service.name service_center, 
							brand.name brand, model.name model,
							rs.name repair_status, rs.id order_status,
							CONCAT(cl.name, ' ', cl.last_name) client,
							u.username assigned_to
							
					FROM 	repair_order repairo
						
						INNER JOIN client cl ON (repairo.client_id = cl.id)
						INNER JOIN operator ON (repairo.operator_id = operator.id)
						INNER JOIN agency ON (repairo.agency_id = agency.id)
						INNER JOIN service_center service ON (repairo.service_center_id = service.id)
						INNER JOIN device_brand brand ON (brand.id = repairo.device_brand_id)
						INNER JOIN device_model model ON (model.id = repairo.device_model_id)
						INNER JOIN repair_status rs ON (repairo.repair_status_id = rs.id)

						LEFT JOIN repair_order_fix rfix ON (rfix.repair_order_id = repairo.id)
						LEFT JOIN user u ON (u.id = rfix.assigned_to)
						
					WHERE repairo.enabled = 1 													
					{$strFilter}";

		//						LEFT JOIN  repair_order_device_replacement oreplacement ON (oreplacement.repair_order_id = repairo.id)
        //						LEFT JOIN  device_replacement replacement ON (replacement.id = oreplacement.device_replacement_id)
													
		//aca chea
        //var_dump($sql);die;

		$stmt = $this->getEntityManager()->getConnection()->prepare($sql);
	    $stmt->execute();
		
	    $execute = $stmt->fetchAll();		   

		return $execute;		
			
		
	}		
	
	
	public function removeDefects($id){
				
		$sql = "DELETE FROM repair_order_device_defect WHERE repair_order_id = {$id}";
		
		$stmt = $this->getEntityManager()->getConnection()->prepare($sql);
	    $stmt->execute();
					
		
	}

	
	public function removeFields($id){
				
		$sql = "DELETE FROM repair_order_additional_field WHERE repair_order_id = {$id}";
		
		$stmt = $this->getEntityManager()->getConnection()->prepare($sql);
	    $stmt->execute();
					
		
	}		
	
	
	
	public function removeAccessories($id){
				
		$sql = "DELETE FROM repair_order_device_accessory WHERE repair_order_id = {$id}";
		$stmt = $this->getEntityManager()->getConnection()->prepare($sql);
	    $stmt->execute();

	}
	
	
	public function assignOrders($tecs, $assignedByID, $asignadoID, $serviceCenter, $orders){
		
		/*	
		print "<pre>";		
		var_dump($asignadoID);die;
		 * */
			
				
		$tecsOrders =  array();	
		//
		$strTecs = "";
		if(!empty($tecs)){
				
			foreach ($tecs as $key => $value) {
				$strTecs .= $strTecs != "" ? ","."'".$key."'" : "'".$key."'";
				//$tecsOrders[$key] = array();
				//$tecsOrders[$key]["id"] = $key;
				$tecsOrders[$key] = 0;
			}
		}
		else{
			////
			//die;
			return true;
		}
		
		/*		
		print "<pre>";
		var_dump($strTecs);die;*/
				
				
				
		/**XBEGING ###/
		 * esta era la forma anterior en donde se traen todas las ordenes por consulta					
		//default ordenes en estado ingreso
		$sqlOrders = "	SELECT 	repairo.id
						FROM	repair_order repairo
							INNER JOIN service_center service ON (repairo.service_center_id = service.id)
							INNER JOIN repair_status rs ON (repairo.repair_status_id = rs.id)
						WHERE repairo.enabled = 1 
						AND service.id =  '{$serviceCenter}'
						AND rs.name = 'INGRESADO'";
													
					
		//print $sql;die;  
		$stmt = $this->getEntityManager()->getConnection()->prepare($sqlOrders);
	    $stmt->execute();
		
	    $orders = $stmt->fetchAll();		   
		
		/**XEND###/
		print "<pre>";
		var_dump($orders);die;
		 * */
		 
		
		//tecnicos y ordenes asignadas
		$sqlTecsOrders = "	SELECT tec.id, COUNT(repairo.id) orders
							FROM 	user tec
								INNER JOIN repair_order_fix repair_fix ON (repair_fix.assigned_to = tec.id)
								INNER JOIN repair_order repairo ON (repairo.id = repair_fix.repair_order_id)
								INNER JOIN repair_status rs ON (rs.id = repairo.repair_status_id)				 
							WHERE 	rs.name IN ('ASIGNADO', 'EN REPARACION', 'PENDIENTE POR REPUESTO', 'PENDIENTE CONFIRMACION DE COSTO')
							AND 	tec.id IN ({$strTecs})
							GROUP BY tec.id";		
							//AND (rs.name = 'INGRESADO' OR rs.name = 'ASIGNADO')
					
		$stmt = $this->getEntityManager()->getConnection()->prepare($sqlTecsOrders);
	    $stmt->execute();
		
	    $execute = $stmt->fetchAll();		   
		
		/*
		print "<pre>";
		var_dump($tecsOrders);die;*/
		
		if(!empty($execute)){
			//si el resultado no es vacio se asigna la respuesta
			foreach ($execute as $key => $value) {
				$executeKey = $value["id"];
				if(array_key_exists($executeKey, $tecsOrders)){
					$tecsOrders[$executeKey] = intval($value["orders"]); 
				}
			}
		}						
		
		/*
		print "<pre>etest";
		var_dump($tecsOrders);die;*/
		
		$arrReturn = array();
			
		//asginacion de ordenes a tecnicos	
		$em = $this->getEntityManager();
		
		foreach ($orders as $key => $value) {
					
			//revisar en $tecOrders el usuario con menos Ordenes				
			$min = min($tecsOrders);
			//var_dump($min, "valor minimo");			//$minKey = array_keys($tecsOrders, $min);
			$minKey = array_search($min, $tecsOrders);
			
			//var_dump($minKey, "llave de valor minimo");						
			$sqlInsert = "INSERT INTO repair_order_fix (repair_order_id, version, assigned_by, assigned_to)
							VALUES ('".$key."', '1', '{$assignedByID}', '{$minKey}')";
			
			//var_dump($sql, "sql");
						
			$stmt = $this->getEntityManager()->getConnection()->prepare($sqlInsert);
		    $stmt->execute();
									
			$tecsOrders[$minKey] = intval($min)+1;
			//var_dump($tecsOrders, "tecOrders");
			
			$sqlInsertStatus = "	INSERT INTO repair_order_status (repair_order_id, repair_status_id, created_at, created_by)
									VALUES ('".$key."', '{$asignadoID}', NOW(), '{$assignedByID}' )";
									
			$stmt = $this->getEntityManager()->getConnection()->prepare($sqlInsertStatus);
		    $stmt->execute();
			
			//UPDATE status in order_repair
			$sqlupdateStatus = "	UPDATE 	repair_order 
									SET    	repair_status_id = '{$asignadoID}'
									WHERE	id = ".$key;
									
			$stmt = $this->getEntityManager()->getConnection()->prepare($sqlupdateStatus);
		    $stmt->execute();
		    
			
			///get & push values into the returning array
			$objOrder = $em->getRepository("SolucelAdminBundle:RepairOrder")->find($key);
			$ticketNumber = $objOrder->getTicketNumber();
			
			$objTech = $em->getRepository("SolucelAdminBundle:User")->find($minKey);
			$tech = $objTech->getUsername();
			
			array_push($arrReturn, array("tech" => $tech, "ticket" => $ticketNumber));
			
												
		}		

		//print "<pre>";
		//var_dump($arrReturn);
		return $arrReturn;
							
	}


	public function getTecAssignedOrders($tecID, $serviceCenterID = null, $operatorID = null, $brandID = null){
		
		$filter = "";
		
		//filtro de técnico
		if($tecID != 0){
			$filter .= " AND tec.id = '{$tecID}' ";
		}

		
		//filtro de Centro de Servicio
		if(intval($serviceCenterID) != 0){
			$filter .= " AND center.id = '{$serviceCenterID}' ";
		}

		//filtro de Operador
		if(intval($operatorID) != 0){
			$filter .= " AND operator.id = '{$operatorID}' ";
		}

	
		//filtro de Marca
		if(intval($brandID) != 0){
			$filter .= " AND brand.id = '{$brandID}' ";
		}

		
								
		//tecnicos y ordenes asignadas
		$sqlTecsOrders = "	SELECT 	DISTINCT(repairo.id), repairo.ticket_number,  tec.id tec, tec.username, 
									repairo.id, repairo.created_at, repairo.entry_date, repairo.device_imei, repairo.device_code_fab,  repairo.estimated_delivery_date,
									brand.name brand, model.name model,
									center.name service_center,
									operator.name operator,
									rs.name status
									
									
							FROM 	user tec
								INNER JOIN repair_order_fix repair_fix ON (repair_fix.assigned_to = tec.id)
								INNER JOIN repair_order repairo ON (repairo.id = repair_fix.repair_order_id)
								INNER JOIN repair_status rs ON (rs.id = repairo.repair_status_id)
								INNER JOIN device_brand brand ON (repairo.device_brand_id = brand.id) 				 
								INNER JOIN device_model model ON (repairo.device_model_id = model.id)
								INNER JOIN service_center center ON (repairo.service_center_id = center.id) 
								INNER JOIN operator operator ON (repairo.operator_id = operator.id)
								
								
							WHERE  rs.name IN ('ASIGNADO','EN REPARACION', 'PENDIENTE POR REPUESTO', 'PENDIENTE CONFIRMACION DE COSTO', 'CONTROL DE CALIDAD TECNICO')
							AND repairo.enabled = 1
							{$filter}
							ORDER BY tec";		
							//AND (rs.name = 'INGRESADO' OR rs.name = 'ASIGNADO')
							//qa.id quality_id, qa.quality_approved, qa.qa_comment
							//LEFT JOIN  repair_order_quality_control qa ON (repairo.id = qa.repair_order_id)
					
																		
		$stmt = $this->getEntityManager()->getConnection()->prepare($sqlTecsOrders);
	    $stmt->execute();
		
	    $execute = $stmt->fetchAll();
	    
        
				
		return $execute;					
		
	}
	
	public function getRepairOrderConfirmation($serviceCenterID = null, $operatorID = null, $brandID = null){
		
		$filter = "";
		
		//filtro de Centro de Servicio
		if(intval($serviceCenterID) != 0){
			$filter .= " AND center.id = '{$serviceCenterID}' ";
		}

		//filtro de Operador
		if(intval($operatorID) != 0){
			$filter .= " AND operator.id = '{$operatorID}' ";
		}

	
		//filtro de Marca
		if(intval($brandID) != 0){
			$filter .= " AND brand.id = '{$brandID}' ";
		}

		
								
		//tecnicos y ordenes asignadas
		$sqlTecsOrders = "	SELECT 	DISTINCT(repairo.id), repairo.ticket_number, tec.id tec, tec.username, 
									repairo.id, repairo.created_at, repairo.entry_date, repairo.device_imei, repairo.device_code_fab, 
									brand.name brand, model.name model,
									center.name service_center,
									operator.name operator,
									rs.name status,
									repair_fix.id orderFixID
									
							FROM 	user tec
								INNER JOIN repair_order_fix repair_fix ON (repair_fix.assigned_to = tec.id)
								INNER JOIN repair_order repairo ON (repairo.id = repair_fix.repair_order_id)
								INNER JOIN repair_status rs ON (rs.id = repairo.repair_status_id)
								INNER JOIN device_brand brand ON (repairo.device_brand_id = brand.id) 				 
								INNER JOIN device_model model ON (repairo.device_model_id = model.id)
								INNER JOIN service_center center ON (repairo.service_center_id = center.id) 
								INNER JOIN operator operator ON (repairo.operator_id = operator.id)
								
							WHERE  rs.name IN ('PENDIENTE CONFIRMACION DE COSTO')
							{$filter}
							ORDER BY tec";		
							//AND (rs.name = 'INGRESADO' OR rs.name = 'ASIGNADO')
					
																		
		$stmt = $this->getEntityManager()->getConnection()->prepare($sqlTecsOrders);
	    $stmt->execute();
		
	    $execute = $stmt->fetchAll();
        
				
		return $execute;					
		
	}	
	
	public function checkRepairInsert($orderID){
				
			
		$sql = "SELECT 	COUNT(repairo.id) count 
				FROM 	repair_order repairo
					INNER JOIN repair_status rs ON (rs.id = repairo.repair_status_id)
				AND rs.name = 'ASIGNADO'
				AND repairo.id = '{$orderID}'";
				/*
				WHERE ros.repair_status_id = (	SELECT MAX(repair_status_id) 
				FROM repair_order_status 
				WHERE repair_order_status.repair_order_id = repairo.id)
				 * */					
		$stmt = $this->getEntityManager()->getConnection()->prepare($sql);
	    $stmt->execute();
		
	    $execute = $stmt->fetchAll();
	    
	    if($execute[0]["count"] > 0){
	    	return true;
	    }
		else{
			return false;	
		}
		
	}

    public function myFilter($filterOperator, $filterBrand){

        $strFilter = "";

        if($filterOperator != 0){
            $strFilter .= " AND ro.operator_id =  {$filterOperator} ";
        }
        if($filterBrand != 0){
            $strFilter .= " AND ro.device_brand_id =  {$filterBrand} ";
        }

        return $strFilter;
    }
	
	public function getOrderStatus($orderID){
		
					
		$sql = "	SELECT 	rs.id, rs.name
					FROM 	repair_order rorder								
						INNER JOIN repair_status rs ON (rs.id = rorder.repair_status_id)
					WHERE rorder.id = {$orderID}";
																		
		$stmt = $this->getEntityManager()->getConnection()->prepare($sql);
	    $stmt->execute();
		
	    $execute = $stmt->fetchAll();
	    //var_dump($execute);die;
		foreach ($execute as $return) {
			return $return;
		}
		
		//return $execute;					
		
	}
	
		
	//cleanOrderFixes
	public function cleanOrderFixes($orderID){
		
		$sql = "	DELETE
					FROM 	repair_order_device_fix_type 
					WHERE 	repair_order_id = '{$orderID}'";
					
		$stmt = $this->getEntityManager()->getConnection()->prepare($sql);
	    $stmt->execute();
		
	}	
	
	
	//cleanOrderFixes
	public function cleanOrderReplacements($orderID){
		
		$sql = "	DELETE
					FROM 	repair_order_device_replacement 
					WHERE 	repair_order_id = '{$orderID}'";
					
		$stmt = $this->getEntityManager()->getConnection()->prepare($sql);
	    $stmt->execute();
		
	}
	
	public function getQualityControlOrders($serviceID){
			
		$strFilter = "";								
		if($serviceID != 0){
			$strFilter = " AND repairo.service_center_id = {$serviceID} ";
		}									
								
		//ordenes para control de calidad
		$sqlTecsOrders = "	SELECT 	DISTINCT(repairo.id), repairo.ticket_number, tec.id tec, tec.username, qa.id qa_id, 
									repairo.id, repairo.created_at, repairo.entry_date, repairo.device_imei, repairo.device_code_fab, 
									brand.name brand, model.name model,
									center.name service_center,
									operator.name operator,
									rs.name status
									
							FROM 	user tec
								INNER JOIN repair_order_fix repair_fix ON (repair_fix.assigned_to = tec.id)
								INNER JOIN repair_order repairo ON (repairo.id = repair_fix.repair_order_id)
								INNER JOIN repair_status rs ON (rs.id = repairo.repair_status_id)
								INNER JOIN device_brand brand ON (repairo.device_brand_id = brand.id) 				 
								INNER JOIN device_model model ON (repairo.device_model_id = model.id)
								INNER JOIN service_center center ON (repairo.service_center_id = center.id) 
								INNER JOIN operator operator ON (repairo.operator_id = operator.id)
								INNER JOIN repair_order_quality_control qa ON (repairo.id = qa.repair_order_id)
								
							WHERE  rs.name IN ('CONTROL DE CALIDAD')
							{$strFilter}
							ORDER BY tec";		
							//AND (rs.name = 'INGRESADO' OR rs.name = 'ASIGNADO')
					
																		
		$stmt = $this->getEntityManager()->getConnection()->prepare($sqlTecsOrders);
	    $stmt->execute();
		
	    $execute = $stmt->fetchAll();
	    
        
				
		return $execute;				
		
	}	
	
	
	public function getOrderHistory($orderID){
			
		//ordenes para control de calidad
		$sqlTecsOrders = "	SELECT 	ros.id, ros.created_at, u.username created_by,
									rs.name status
							FROM 	repair_order_status	ros	
								INNER JOIN repair_status rs ON (ros.repair_status_id = rs.id)
								INNER JOIN user u ON (ros.created_by = u.id)
							WHERE	repair_order_id = {$orderID}						
							ORDER BY ros.id";
							//ORDER BY UNIX_TIMESTAMP(created_at) ASC		
							//AND (rs.name = 'INGRESADO' OR rs.name = 'ASIGNADO')
					
																		
		$stmt = $this->getEntityManager()->getConnection()->prepare($sqlTecsOrders);
	    $stmt->execute();
		
	    $execute = $stmt->fetchAll();
				
		return $execute;	
		
				
	}
	

	//public function findReplacement($term, $model){//use to be by model
		public function findReplacement($term, $brand){
			
		$brand = intval(urldecode($brand));

		$sql = "	SELECT 	r.id, r.name, rt.name tipo, r.replacement_code codigo
					FROM	device_replacement r
						INNER JOIN device_replacement_type rt ON (rt.id = r.device_replacement_type_id)
					WHERE	(r.name LIKE '%".$term."%' OR r.replacement_code LIKE '%".$term."%')
					AND	    r.device_brand_id = {$brand}
					AND     r.enabled = 1 
					";
					
		//print $sql;die;
		/*

		$sql = "	SELECT 	r.id, r.name, rt.name tipo, r.replacement_code codigo
					FROM	device_replacement r
						INNER JOIN device_replacement_type rt ON (rt.id = r.device_replacement_type_id)
						INNER JOIN device_model model ON (r.device_model_id = model.id)
					WHERE	(r.name LIKE '%".$term."%' OR r.replacement_code LIKE '%".$term."%')
					AND	model.name LIKE '%{$brand}%'";
		 * */


		/*
		$sql = "	SELECT 	r.id, r.name, rt.name tipo, r.replacement_code codigo
					FROM	device_replacement r
						INNER JOIN device_replacement_type rt ON (rt.id = r.device_replacement_type_id)
						INNER JOIN device_model model ON (r.device_model_id = model.id)
					WHERE	(r.name LIKE '%".$term."%' OR r.replacement_code LIKE '%".$term."%')
					AND	model.name LIKE '%{$model}%'";
		 * */
					//AND	model.id = {$model}";
					//
					//
					//print $sql;die;
					//
					 
		   
		$stmt = $this->getEntityManager()->getConnection()->prepare($sql);
	    $stmt->execute();
		
	    $execute = $stmt->fetchAll();		   
		
		$replacements = array();
        foreach ($execute as $entity)
        {
            //$clients[] = $entity["name"];
            array_push($replacements, array('value'=>$entity["name"]."/ ".$entity["codigo"], 'id'=> $entity["id"], 'name' =>$entity["name"], 'codigo' =>$entity["codigo"]));
        }
		
		return $replacements;

		
	}	
	
	
	public function filterDelivery($request){
			
		
		/*
		print "<pre>";
		var_dump($request);die;
		 * 
		 */
		
		
		

		
		$strFilter  = "";
		
		if(isset($request["filter_dates"]) && $request["filter_dates"] != 0){
		$strFilter = " AND (DATE(repairo.entry_date) >= '".$request["filter_created_from"]. "'  AND DATE(repairo.entry_date) <= '".$request["filter_created_to"]."')";
		}
		if(isset($request["filter_operator"]) && $request["filter_operator"] != 0){
			$strFilter .= " AND operator.id = ".$request["filter_operator"];
		}
		
		if(isset($request["filter_brand"]) && $request["filter_brand"] != 0){
			$strFilter .= " AND brand.id = ".$request["filter_brand"];
		}
		
		if(isset($request["filter_agency"]) && $request["filter_agency"] != 0){
			$strFilter .= " AND agency.id = ".$request["filter_agency"];
		}
		if(isset($request["filter_service_center"]) && $request["filter_service_center"] != 0){
			$strFilter .= " AND service.id = ".$request["filter_service_center"];
		}						
		if(isset($request["filter_status"]) && $request["filter_status"] != 0){
			$strFilter .= " AND repairo.repair_status_id = ".$request["filter_status"];
		}

		
		if(isset($request["ticket_search"]) && $request["ticket_search"] != ""){
			
			$implode = explode(",", $request["ticket_search"]);
			
			$strIn = "";
			foreach ($implode as $key => $value) {
			    $myValue = trim($value);
				$strIn .= $strIn == "" ? "'".$myValue."'" : ",'".$myValue."'";
			}
			
			//$strFilter .= " AND repairo.id IN($strIn)";
			$strFilter .= " AND repairo.ticket_number IN($strIn)";
		}
						
				
		//default ordenes en estado ingreso
		//ros.repair_status_id order_status
		//rs.name repair_status,
		$sql = "	SELECT 	DISTINCT(repairo.id), repairo.ticket_number, brand.name brand, repairo.device_imei imei, model.name model, 
							client.phone, CONCAT(client.name, ' ', client.last_name) client, 
							GROUP_CONCAT(accessory.name SEPARATOR ', ') accessories,
							GROUP_CONCAT(fixlevel.name SEPARATOR ', ') fixlevel,
							GROUP_CONCAT(fixtype.name SEPARATOR ', ') fixtype
							
							 
					FROM 	repair_order repairo
						INNER JOIN operator ON (repairo.operator_id = operator.id)
						INNER JOIN agency ON (repairo.agency_id = agency.id)
						INNER JOIN service_center service ON (repairo.service_center_id = service.id)
						INNER JOIN device_brand brand ON (brand.id = repairo.device_brand_id)
						INNER JOIN device_model model ON (model.id = repairo.device_model_id)
						INNER JOIN repair_status rs ON (repairo.repair_status_id = rs.id)
						INNER JOIN client ON (repairo.client_id = client.id)
						
						LEFT JOIN repair_order_device_accessory daccessory ON (repairo.id = daccessory.repair_order_id)
						LEFT JOIN device_accessory accessory ON (accessory.id = daccessory.device_accessory_id)
						
						LEFT JOIN repair_order_device_fix_type repairfixtype ON (repairo.id = repairfixtype.repair_order_id)
						LEFT JOIN device_fix_type fixtype ON (repairfixtype.device_fix_type_id = fixtype.id)
						LEFT JOIN device_fix_level fixlevel ON (fixtype.device_fix_level_id = fixlevel.id)
						
						
					WHERE repairo.enabled = 1 													
					{$strFilter}
					GROUP BY repairo.id";
													
					
		//print $sql;die;
		$stmt = $this->getEntityManager()->getConnection()->prepare($sql);
	    $stmt->execute();
		
	    $execute = $stmt->fetchAll();
	    
	    //var_dump($execute);die;		   

		return $execute;		
					
		
	}
	
	
	
	###FUNCTIONS FROM CONSOLIDATED REPORT###
	//getReplacementsByRepairOrder
	public function getReplacementsByRepairOrder($orderID){
					
				
		//rs.name repair_status,
		$sql = "	SELECT 	r.name, r.replacement_code, r.strdatabase, ror.quantity
					FROM	repair_order_device_replacement ror
						INNER JOIN device_replacement r ON (ror.device_replacement_id = r.id)
					WHERE	ror.repair_order_id = {$orderID}
					LIMIT 7";
													
					
		//print $sql;die;  
		$stmt = $this->getEntityManager()->getConnection()->prepare($sql);
	    $stmt->execute();
		
	    $execute = $stmt->fetchAll();
	    
	    //print "<pre>";
	    //var_dump($execute);die;		   

		return $execute;				
		
	}	
	
	//RepairOrderDeviceFixType
	public function getFixTypeByRepairOrder($orderID){
			
		$sql = "	SELECT 	d.id, d.name, l.name level 
					FROM	repair_order_device_fix_type ft
						INNER JOIN device_fix_type d ON (ft.device_fix_type_id = d.id)
						INNER JOIN device_fix_level l ON (d.device_fix_level_id = l.id)
					WHERE	ft.repair_order_id = {$orderID}
					LIMIT 1";
													
					
		//print $sql;die;  
		$stmt = $this->getEntityManager()->getConnection()->prepare($sql);
	    $stmt->execute();
		
	    $execute = $stmt->fetchAll();
	    
	    //print "<pre>";
	    //var_dump($execute);die;		   

		return $execute;				
		
	}			
	
	
	//getAddFieldByRepairOrder
	public function getAddFieldByRepairOrder($orderID){
			
		$sql = "	SELECT 	af.name, af.value 
					FROM	repair_order_additional_field af
					WHERE	af.repair_order_id = {$orderID}";
													
					
		//print $sql;die;  
		$stmt = $this->getEntityManager()->getConnection()->prepare($sql);
	    $stmt->execute();
		
	    $execute = $stmt->fetchAll();
	    
	    //print "<pre>";
	    //var_dump($execute);die;		   

		return $execute;				
		
	}
	
	//RepairOrderQualityControl
	public function getQualityControlByRepairOrder($orderID){
					
				
		$sql = "	SELECT 	u.username, qc.created_at
					FROM	repair_order_quality_control qc
						INNER JOIN user u ON (qc.created_by = u.id)
					WHERE	qc.repair_order_id = {$orderID}";
													
					
		//print $sql;die;  
		$stmt = $this->getEntityManager()->getConnection()->prepare($sql);
	    $stmt->execute();
		
	    $execute = $stmt->fetchAll();
	    
	    //print "<pre>";
	    //var_dump($execute);die;		   

		return $execute;				
		
	}	
	
	
	public function getRepairStatusByRepairOrder($orderID, $statusID){


		$sql = "	SELECT 	u.username, os.created_at
					FROM	repair_order_status os
						INNER JOIN user u ON (os.created_by = u.id)
					WHERE	os.repair_order_id = {$orderID}
					AND		os.repair_status_id = {$statusID}";
													
					
		//print $sql;die;  
		$stmt = $this->getEntityManager()->getConnection()->prepare($sql);
	    $stmt->execute();
		
	    $execute = $stmt->fetchAll();
	    
	    //print "<pre>";
	    //var_dump($execute);die;		   

		return $execute;	
		
	}


    public function getLastRepairmentDate($orderID, $statusID){


        $sql = "	SELECT 	os.created_at
					FROM	repair_order_status os
					WHERE	os.repair_order_id = {$orderID}
					AND		os.repair_status_id = {$statusID}
					ORDER BY os.created_at DESC
					LIMIT 1";


        //print $sql;die;
        $stmt = $this->getEntityManager()->getConnection()->prepare($sql);
        $stmt->execute();

        $execute = $stmt->fetchAll();

        //print "<pre>";
        //var_dump($execute);die;

        return $execute;

    }

	
	//RepairOrderDeviceAccessory				
	public function getAccessoryByRepairOrder($orderID){
				
		$sql = "	SELECT 	c.name, c.description
					FROM	repair_order_device_accessory p
						INNER JOIN device_accessory c ON (p.device_accessory_id = c.id)
					WHERE	p.repair_order_id = {$orderID}";
													
					
		//print $sql;die;  
		$stmt = $this->getEntityManager()->getConnection()->prepare($sql);
	    $stmt->execute();
		
	    $execute = $stmt->fetchAll();
	    
	    //print "<pre>";
	    //var_dump($execute);die;		   

		return $execute;				
		
	}
	
	//RepairOrderDeviceDefect
	public function getDefectByRepairOrder($orderID){
				
		$sql = "	SELECT 	c.id, c.name, cc.name defect_type
					FROM	repair_order_device_defect p
						INNER JOIN device_defect c ON (p.device_defect_id = c.id)
						INNER JOIN device_defect_type cc ON (c.device_defect_type_id = cc.id)
					WHERE	p.repair_order_id = {$orderID}";
													
					
		//print $sql;die;  
		$stmt = $this->getEntityManager()->getConnection()->prepare($sql);
	    $stmt->execute();
		
	    $execute = $stmt->fetchAll();
	    
	    //print "<pre>";
	    //var_dump($execute);die;		   

		return $execute;				
		
	}		
	
	//getFixTypeByRepairOrder
	/*
	public function getFixTypeByRepairOrder($orderID){
				
		$sql = "	SELECT 	c.id, c.name
					FROM	repair_order_device_fix_type p
						INNER JOIN device_fix_type c ON (p.device_fix_type_id = c.id)
					WHERE	p.repair_order_id = {$orderID}";
													
					
		//print $sql;die;  
		$stmt = $this->getEntityManager()->getConnection()->prepare($sql);
	    $stmt->execute();
		
	    $execute = $stmt->fetchAll();
	    
	    //print "<pre>";
	    //var_dump($execute);die;		   

		return $execute;				
		
	}	
	 * 
	 */
	 
	 public function getMotoDataFeed(){

         ///IT IS NOW WORKING
         DIE;

	 		
	 	$sql = " 	SELECT  reasoncode.code action_reason_code,
	 						repairo.ticket_number claim_id,  DATE_FORMAT(repairo.created_at, '%Y-%m-%d %T') date_in, DATE_FORMAT(repairo.updated_at, '%Y-%m-%d %T') date_out,
	 						country.name enduser_country, client.email enduser_email, repairo.ticket_number enduser_id, CONCAT(client.name, ' ', client.last_name) enduser_name,
	 						client.contact_phone enduser_phonenumber, state.name enduser_town, state.zip_code enduser_zipcode, pfcode.code fault_code,
	 						repairo.device_imei2 imei2_in, repairo.device_imei2_out imei2_out, 
	 						repairo.device_imei imei_number_in, repairo.device_imei_out imei_number_out, DATE_FORMAT(repairo.device_manufacture_date, '%Y-%m-%d %T') manufacture_date,
	 						brand.name oem, payer.code payer,
	 						DATE_FORMAT(repairo.device_purchase_date, '%Y-%m-%d %T') pop_date, pfcode.code problem_found_code,
	 						model.product_code_in, model.product_code_out, dtype.code product_type, 
	 						'MOTOROLA' project, 'GT000003' repair_service_partner_id, rstatus.repair_status_code, DATE_FORMAT(repairfix.updated_at, '%Y-%m-%d %T') repair_timestamp, DATE_FORMAT(NOW(), '%Y-%m-%d %T') report_date,
	 						repairo.device_msn serial_number_in, repairo.device_msn_out serial_number_out,
	 						'GT000003' shop_id,  repairfix.software_out,
							tcode.transaction_code, repairo.warranty_flag, COUNT(replacement.id)  quantity_replaced,  replacement.replacement_code material_number, 		
							repairo.id repair_order_id, brand.id brand_id
	 						
	 				FROM	repair_order repairo
	 					INNER JOIN client ON (client.id = repairo.client_id)
	 					INNER JOIN state ON (state.id = client.state_id)
	 					INNER JOIN country ON (country.id = state.country_id)
						INNER JOIN device_brand brand ON (brand.id = repairo.device_brand_id)
						INNER JOIN device_model model ON (model.id = repairo.device_model_id)  
						INNER JOIN device_type dtype ON (dtype.id = repairo.device_type_id)
						LEFT JOIN payer ON (payer.id = repairo.payer_id)
	 					LEFT JOIN repair_order_fix	repairfix ON (repairo.id= repairfix.repair_order_id )
	 					LEFT JOIN action_reason_code reasoncode ON (reasoncode.id = repairfix.action_reason_code_id)
	 					LEFT JOIN repair_status rstatus ON (rstatus.id = repairo.repair_status_id)
						LEFT JOIN problem_found_code pfcode ON (pfcode.id = repairfix.problem_found_code_id)
	 					LEFT JOIN transaction_code tcode ON (tcode.id = repairfix.transaction_code_id)
						LEFT JOIN repair_order_device_replacement oreplacement ON (repairo.id = oreplacement.repair_order_id)
						LEFT JOIN device_replacement replacement ON (replacement.id = oreplacement.device_replacement_id)
						
	 				WHERE 	brand.name = 'Motorola'
	 				AND 	repairo.repair_status_id != 11
	 				
	 				AND		repairo.enabled = 1
	 				GROUP BY material_number, repairo.id
	 				ORDER BY repairo.id, date_in;
					";
					//
					//var_dump($sql);die;
					
					//JOIN
					//SELECT					
					//,
					
					/*
					 * 
	 				AND		( DATE(repairo.updated_at) = DATE(NOW()) OR DATE(repairo.created_at) = DATE(NOW()) 
	 							OR 		DATE(repairfix.updated_at) = DATE(NOW()) )
					 * 
					 * */
		
		///PARA ESTOS QUERIES FALTA LA RELACION MARCA PARA RESTRICCION
					
		$stmt = $this->getEntityManager()->getConnection()->prepare($sql);
	    $stmt->execute();
		
	    $execute = $stmt->fetchAll();
	    //print "<pre>";
	    //var_dump($execute);die;				

		$arrReturn = array();
		if(!empty($execute)){
			//si el resultado no es vacio se asigna la respuesta
			foreach ($execute as $rkey => $row) {
						
				$orderID = $row["repair_order_id"];				
			    //print "<pre>";
			    //var_dump($row);die;					
				//$arrReturn = array($rkey => array());
				//$arrReturn = array();	
				foreach ($row as $key => $value) {
					
					if($key != "repair_order_id" || $key != "brand_id"){
						//$arrReturn[$key] = $value;	
						$arrReturn[$rkey][$key] =  $value;
					}
					
				}	

				$arrReturn[$rkey]["action_code"] =  $this->getActionCode($orderID, $row["brand_id"]);
				$faultCodes = $this->getFaultCode($orderID, $row["brand_id"]);
				
				if($faultCodes != NULL){
					//var_dump($faultCodes);die;
					$arrReturn[$rkey]["customer_complaint_code_primary"] = $faultCodes[0]["fault_code"];
						
					if(isset($faultCodes[1])){
						$arrReturn[$rkey]["customer_complaint_code_secondary"] = $faultCodes[1]["fault_code"];
					}	
						
				}
				
				 
				
				/*
				$arrMaterial = $this->getMaterialNumber($orderID);
				
				$arrReturn[$rkey]["quantity_replaced"] = $arrMaterial["quantity_replaced"];
				$arrReturn[$rkey]["material_number"] = $arrMaterial["material_number"];
				 * */
						
				
			}
		}	
	    
	    //print "<pre>";
	    //var_dump($arrReturn);die;		   

		return $arrReturn;						
	 	
	 }

	public function getActionCode($orderID, $brandID){
		
		$sql = " SELECT fixlevel.name, fixlevel.id, fixcode.fix_type_code action_code
				 FROM   repair_order_device_fix_type repairfixtype 
						INNER JOIN device_fix_type fixtype ON (fixtype.id = repairfixtype.device_fix_type_id)
						INNER JOIN device_fix_type_code fixcode ON (repairfixtype.device_fix_type_id = fixcode.device_fix_type_id AND fixcode.device_brand_id = {$brandID}) 				
						INNER JOIN device_fix_level fixlevel ON (fixlevel.id = fixtype.device_fix_level_id)
				WHERE repairfixtype.repair_order_id = {$orderID}
				ORDER BY fixlevel.name ASC
				LIMIT 1";
		
		$stmt = $this->getEntityManager()->getConnection()->prepare($sql);
	    $stmt->execute();
		
	    $execute = $stmt->fetchAll();


		$arrReturn = "NULL";
		if(!empty($execute)){			
			$arrReturn = $execute[0]["action_code"];	
		}

	    
	    //print "<pre>";
	    //var_dump($execute);die;		   

		return $arrReturn;						
		
		
	}
	
	public function getFaultCode($orderID, $brandID){

		$sql = "	SELECT 	defectcode.defect_code fault_code
					FROM	repair_order_device_defect orderdefect
						INNER JOIN device_defect defect ON (defect.id = orderdefect.device_defect_id)
						INNER JOIN device_defect_code defectcode ON (defectcode.device_defect_id = defect.id AND defectcode.device_brand_id = {$brandID})
					
					LIMIT 2";
					//WHERE orderdefect.repair_order_id = {$orderID}	
					
		//print $sql;die;
					
		$stmt = $this->getEntityManager()->getConnection()->prepare($sql);
	    $stmt->execute();
		
	    $execute = $stmt->fetchAll();


		$arrReturn = NULL;
		if(!empty($execute)){
			//var_dump($execute);die;
			$arrReturn = $execute;	
		}

	    
	    //print "<pre>";
	    //var_dump($execute);die;		   

		return $arrReturn;						
	}
	
	public function getMaterialNumber($orderID){
			
		 //MATERIAL NUMBER (REPLACEMENTS)
		 /*
		 $sql = "	SELECT	COUNT(replacement.id) quantity_replaced, GROUP_CONCAT(replacement.replacement_code SEPARATOR ';') material_number
					FROM	repair_order_device_replacement oreplacement
						INNER JOIN device_replacement replacement ON (replacement.id = oreplacement.device_replacement_id)
					WHERE	oreplacement.repair_order_id = {$orderID}";
		  *
		  */
		  
		 $sql = "	SELECT	COUNT(replacement.id) quantity_replaced, replacement.replacement_code material_number
					FROM	repair_order_device_replacement oreplacement
						INNER JOIN device_replacement replacement ON (replacement.id = oreplacement.device_replacement_id)
					WHERE	oreplacement.repair_order_id = {$orderID}
					GROUP BY material_number";
		  		  
					
		$stmt = $this->getEntityManager()->getConnection()->prepare($sql);
	    $stmt->execute();
		
	    $execute = $stmt->fetchAll();


		$arrReturn = array(0 => array("quantity_replaced" => "NULL", "material_number" => "NULL"));
		if(!empty($execute)){
			
			foreach ($execute as $key => $value) {
				$arrReturn[$key]["quantity_replaced"] = $value["quantity_replaced"];	
				$arrReturn[$key]["material_number"] = $value["material_number"];
				
			}			
		}

	    
	    //print "<pre>";
	    //var_dump($execute);die;		   

		return $arrReturn;						
		
	}

	public function getUnfinishedOrders(){
				
		 $sql = "	SELECT	repairo.id
					FROM	repair_order repairo
						INNER JOIN repair_status rs ON (repairo.repair_status_id = rs.id)
					WHERE	repairo.enabled = 1 
					AND 	rs.name IN ('CAMBIO POR GARANTIA', 'FINALIZADO', 'NO REPARADO/NO CONFIRMADO', 'IRREPARABLE') 
					ORDER BY repairo.created_at";
		  		  
					
		$stmt = $this->getEntityManager()->getConnection()->prepare($sql);
	    $stmt->execute();
		
	    $execute = $stmt->fetchAll();		
		
		return $execute;	
		
	}




    public function getCountByStatus($from, $to, $filterOperator, $filterBrand){

        $strFilter = $this->myFilter($filterOperator, $filterBrand);

        $sql = "    SELECT	COUNT(ro.id) myCount, rs.name
                    FROM	repair_order ro
	                    INNER JOIN repair_status rs ON (ro.repair_status_id = rs.id)
                    WHERE         (DATE(ro.created_at) >= '{$from}' AND DATE(ro.created_at) <= '{$to}')
                    {$strFilter}
                    GROUP BY rs.id
                    ORDER BY myCount DESC";

        //print $sql;die;

        $stmt = $this->getEntityManager()->getConnection()->prepare($sql);
        $stmt->execute();

        $execute = $stmt->fetchAll();

        if(!empty($execute)){
            return $execute;
        }
        else{
            return array();
        }


    }


    public function getRelapseByYear($filterOperator, $filterBrand){

        $strFilter = $this->myFilter($filterOperator, $filterBrand);

        $currentYear = date("Y");
        $start = $currentYear."-01-01";
        $end = ($currentYear+1)."-01-01";

        $sqlRelapse = "     SELECT  COUNT(ro.id) quantity, MONTH(ro.created_at) myMonth
                            FROM    repair_order ro
                            WHERE   ro.repair_entry_type_id = 3
                            AND     DATE(ro.created_at) >= '{$start}' 
                            AND     DATE(ro.created_at) < '{$end}' 
                            {$strFilter}
                            GROUP BY MONTH(ro.created_at)
                            ORDER BY MONTH(ro.created_at)                    
                       
                        ";

        $stmt = $this->getEntityManager()->getConnection()->prepare($sqlRelapse);
        $stmt->execute();

        $executeRelapse = $stmt->fetchAll();

        $sql = "     SELECT  COUNT(ro.id) quantity, MONTH(ro.created_at) myMonth
                            FROM    repair_order ro
                            WHERE   1=1
                            AND     DATE(ro.created_at) >= '{$start}' 
                            AND     DATE(ro.created_at) < '{$end}' 
                            {$strFilter}
                            GROUP BY MONTH(ro.created_at)
                            ORDER BY MONTH(ro.created_at)                    
                       
                        ";

        $stmt = $this->getEntityManager()->getConnection()->prepare($sql);
        $stmt->execute();

        $execute = $stmt->fetchAll();

        $arrLines = array("quantity", "percentage");

        $myArray = array();

        foreach ($arrLines as $line){
            for ($i = 1 ; $i <= 12; $i++){
                $myArray[$line][$i] = 0;
            }
        }

        //ALL ORDERS
        foreach ($execute as $row) {
            $myArray["quantity"][intval($row["myMonth"])] = intval($row["quantity"]);
        }

        //print "<pre>";
        //var_dump($myArray);die;

        //RELPASE ORDERS
        foreach ($executeRelapse as $row) {
            $relapseQuantity = intval($row["quantity"]);
            $myMonth = intval($row["myMonth"]);

            $ordersQuantity = intval($myArray["quantity"][$myMonth]);
            if($ordersQuantity > 0){
                $percentage = number_format(($relapseQuantity*100) / $ordersQuantity, 2, ".", "") ;
            }
            else{
                $percentage = 0;
            }


            $myArray["percentage"][$myMonth] = $percentage;
        }
        //ALL ORDERS
        foreach ($executeRelapse as $row) {
            $myArray["quantity"][intval($row["myMonth"])] = intval($row["quantity"]);
        }

        //print "<pre>";
        //var_dump($myArray);die;

        return $myArray;
    }

    //getPercentageByLevel

    public function getPercentageByLevel($from, $to, $filterOperator, $filterBrand){

        $strFilter = $this->myFilter($filterOperator, $filterBrand);


        $sqlTotal = "    SELECT	COUNT(DISTINCT(ro.id)) myCount
                         FROM	repair_order ro
                         WHERE         (DATE(ro.created_at) >= '{$from}' AND DATE(ro.created_at) <= '{$to}')
                         {$strFilter}";

        $stmt = $this->getEntityManager()->getConnection()->prepare($sqlTotal);
        $stmt->execute();

        $execute = $stmt->fetchAll();

        $myTotal = intval($execute[0]["myCount"]);


        $sql = "    SELECT	COUNT(ro.id) myCount, rs.name
                    FROM	repair_order ro
	                    INNER JOIN repair_status rs ON (ro.repair_status_id = rs.id)
                    WHERE         (DATE(ro.created_at) >= '{$from}' AND DATE(ro.created_at) <= '{$to}')
                    {$strFilter}    
                    GROUP BY rs.id
                    ORDER BY myCount DESC";

        //print $sql;die;

        $stmt = $this->getEntityManager()->getConnection()->prepare($sql);
        $stmt->execute();

        $execute = $stmt->fetchAll();

        if(!empty($execute)){
            return $execute;
        }
        else{
            return array();
        }

    }



    public function speedometerResponseTimeOrders($from, $to, $filterOperator, $filterBrand){
        //DATEDIFF(CURDATE(), '2015-04-18').

        $strFilter = $this->myFilter($filterOperator, $filterBrand);

        $sqlOperatorDays = "SELECT  days_to_fix_device
                            FROM    operator
                            WHERE   id = {$filterOperator}";

        $stmt = $this->getEntityManager()->getConnection()->prepare($sqlOperatorDays);
        $stmt->execute();

        $execute = $stmt->fetchAll();

        $intOperatorDays = $execute[0]["days_to_fix_device"];

        $sql = "	SELECT 	DISTINCT(ro.id), DATEDIFF(DATE(ros.created_at), DATE(ro.created_at) ) days
					FROM repair_order ro
						INNER JOIN device_brand brand ON (brand.id = ro.device_brand_id)
						INNER JOIN repair_status rs ON (rs.id = ro.repair_status_id) 
						INNER JOIN operator ON (ro.operator_id = operator.id)
						INNER JOIN repair_order_status ros ON (ros.repair_order_id = ro.id)
					WHERE ro.enabled = 1
					AND (DATE(ro.created_at) >= '{$from}' AND DATE(ro.created_at) <= '{$to}')
					{$strFilter} 
					AND ros.repair_status_id IN (10,11)
					
					";
        //10 estado finalizado
        //11 ENTREGADO

        //print $sql;die;
        $stmt = $this->getEntityManager()->getConnection()->prepare($sql);
        $stmt->execute();

        $execute = $stmt->fetchAll();
        /*
        print "<pre>";
        var_dump($execute);die;
         *
         */

        $intOrdersTotal = 0;
        $intOrdersOnTime = 0;

        //print "<pre>";
        foreach ($execute as $row) {
            //var_dump($row);die;
            $days = $row["days"];
            if($days <= $intOperatorDays ){
                $intOrdersOnTime++;
            }
            $intOrdersTotal++;

        }

        $arrReturn = array();

        if($intOrdersTotal != 0){
            $arrReturn["onTime"] = $intOrdersOnTime;
            $arrReturn["green"] = $intOrdersTotal / 3;
            $arrReturn["yellow"] = ($intOrdersTotal/3)*2;
            $arrReturn["red"] = ($intOrdersTotal/3)*3;

            //
            $percentage = number_format(($intOrdersOnTime*100) / $intOrdersTotal, 2, ".", ",") ;
            $arrReturn["percentage"] = $percentage;

        }
        else{
            $arrReturn["onTime"] = 0;
            $arrReturn["percentage"] = 0;
        }

        $arrReturn["total"] = $intOrdersTotal;

        //print "<pre>";
        //var_dump($arrReturn);die;

        return $arrReturn;

    }

		
}
