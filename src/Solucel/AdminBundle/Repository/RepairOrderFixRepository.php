<?php

namespace Solucel\AdminBundle\Repository;

/**
 * RepairOrderFixRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class RepairOrderFixRepository extends \Doctrine\ORM\EntityRepository
{
    
	public function filter($request){

		
		$strFilter  = "";
		
		if(isset($request["filter_dates"]) && $request["filter_dates"] != 0){
		$strFilter = " AND (DATE(repairo.entry_date) >= '".$request["filter_created_from"]. "'  AND DATE(repairo.entry_date) <= '".$request["filter_created_to"]."')";
		}
		if(isset($request["filter_operator"]) && $request["filter_operator"] != 0){
			$strFilter .= " AND operator.id = ".$request["filter_operator"];
		}
		
		if(isset($request["filter_brand"]) && $request["filter_brand"] != 0){
			$strFilter .= " AND brand.id = ".$request["filter_brand"];
		}
		
		if(isset($request["filter_agency"]) && $request["filter_agency"] != 0){
			$strFilter .= " AND agency.id = ".$request["filter_agency"];
		}
		if(isset($request["filter_service_center"]) && $request["filter_service_center"] != 0){
			$strFilter .= " AND service.id = ".$request["filter_service_center"];
		}						
		if(isset($request["filter_status"]) && $request["filter_status"] != 0){
			$strFilter .= " AND repairo.repair_status_id = ".$request["filter_status"];
		}
		if(isset($request["filter_assign"])){
			$strFilter .= " AND rs.name = 'INGRESADO' ";
		}
			
		//filtro para ordenes FINALIZADAS
		if(isset($request["filter_finish"])){
			
			$strFilter .= " AND rs.name IN ('CAMBIO POR GARANTIA', 'FINALIZADO', 'NO REPARADO/NO CONFIRMADO', 'IRREPARABLE') ";//
		}
		
		
		return $strFilter;										
	}
        
    //FilterOrdersEntryByBrandModel    
    public function filterOrdersEBBM($request){
	
		$strFilter  = "";
		
		if(isset($request["filter_dates"]) && $request["filter_dates"] != 0){
		$strFilter = " AND (DATE(repairo.entry_date) >= '".$request["filter_created_from"]. "'  AND DATE(repairo.entry_date) <= '".$request["filter_created_to"]."')";
		}
		if(isset($request["filter_operator"]) && $request["filter_operator"] != 0){
			$strFilter .= " AND operator.id = ".$request["filter_operator"];
		}
		
		if(isset($request["filter_brand"]) && $request["filter_brand"] != 0){
			$strFilter .= " AND brand.id = ".$request["filter_brand"];
		}
		
		if(isset($request["filter_agency"]) && $request["filter_agency"] != 0){
			$strFilter .= " AND agency.id = ".$request["filter_agency"];
		}
		if(isset($request["filter_service_center"]) && $request["filter_service_center"] != 0){
			$strFilter .= " AND service.id = ".$request["filter_service_center"];
		}						
		if(isset($request["filter_status"]) && $request["filter_status"] != 0){
			$strFilter .= " AND repairo.repair_status_id = ".$request["filter_status"];
		}
		if(isset($request["filter_assign"])){
			$strFilter .= " AND rs.name = 'INGRESADO' ";
		}
			
		//filtro para ordenes FINALIZADAS
		if(isset($request["filter_finish"])){
			
			$strFilter .= " AND rs.name IN ('CAMBIO POR GARANTIA', 'FINALIZADO', 'NO REPARADO/NO CONFIRMADO', 'IRREPARABLE') ";//
		}								
				
		$sql = "	SELECT 	DISTINCT(model.name) as model, brand.name brand, count(model.name) as quantity,
                                        operator.name operator, agency.name agency, service.name service_center,
                                        rs.name repair_status, repairo.created_at
					FROM repair_order repairo
                                        INNER JOIN operator ON (repairo.operator_id = operator.id)
                                        INNER JOIN agency ON (repairo.agency_id = agency.id)
                                        INNER JOIN service_center service ON (repairo.service_center_id = service.id)
					INNER JOIN device_brand brand ON (brand.id = repairo.device_brand_id)
					INNER JOIN device_model model ON (model.id = repairo.device_model_id)
                                        INNER JOIN repair_status rs ON (repairo.repair_status_id = rs.id)
					WHERE repairo.enabled = 1													
					{$strFilter}"
                                        . " GROUP BY model, brand, operator, agency, service_center, repair_status, created_at
                                        HAVING count(model.name) > 1";
													
					
		//print $sql;die;  
		$stmt = $this->getEntityManager()->getConnection()->prepare($sql);
	    $stmt->execute();
		
	    $execute = $stmt->fetchAll();		   

		return $execute;		
			
		
	}

        
        //FilterOrdersEntryByYearOrder
	public function filterOrdersEBYO($request){
	
		$strFilter  = "";
		
		if(isset($request["filter_dates"]) && $request["filter_dates"] != 0){
//                    if(strlen($request["filter_created_to"])>4){
//                        $filter_created_to = substr($request["filter_created_to"], 0, 4);
//                    }else  $filter_created_to = $request["filter_created_to"];
                    $select_year = $request["select_year"];
                    $year_before = $request["year_before"];
                        $strFilter = " AND YEAR(repairo.created_at) >= " .$year_before 
                                   . " AND YEAR(repairo.created_at) <= " .$select_year;
//                         $strFilter = " AND YEAR(repairo.created_at) = " .$select_year;
		}
		if(isset($request["filter_operator"]) && $request["filter_operator"] != 0){
			$strFilter .= " AND operator.id = ".$request["filter_operator"];
		}
		
		if(isset($request["filter_brand"]) && $request["filter_brand"] != 0){
			$strFilter .= " AND brand.id = ".$request["filter_brand"];
		}
		
		if(isset($request["filter_agency"]) && $request["filter_agency"] != 0){
			$strFilter .= " AND agency.id = ".$request["filter_agency"];
		}
		if(isset($request["filter_service_center"]) && $request["filter_service_center"] != 0){
			$strFilter .= " AND service.id = ".$request["filter_service_center"];
		}						

			
							
				
		$sql = "	SELECT 	count(repairo.id) as quantity, MONTH(repairo.created_at) as monthname, YEAR(repairo.created_at) as yearname
					FROM repair_order repairo
                                        INNER JOIN operator ON (repairo.operator_id = operator.id)
                                        INNER JOIN agency ON (repairo.agency_id = agency.id)
                                        INNER JOIN service_center service ON (repairo.service_center_id = service.id)
										INNER JOIN device_brand brand ON (brand.id = repairo.device_brand_id)
										INNER JOIN device_model model ON (model.id = repairo.device_model_id)
                                        INNER JOIN repair_status rs ON (repairo.repair_status_id = rs.id)
					WHERE repairo.enabled = 1													
					{$strFilter}"
                                        . " GROUP BY monthname, yearname
                                        ORDER BY MONTH(repairo.created_at) ASC";
													
					
//                  print $sql;die;  
		$stmt = $this->getEntityManager()->getConnection()->prepare($sql);
	    $stmt->execute();
		
	    $execute = $stmt->fetchAll();		   

		return $execute;		
			
		
	}
	
        
	public function filterPendingStatusOrders($request){
				

		$strFilter = $this->filter($request);
				
		//default ordenes en estado ingreso
		//ros.repair_status_id order_status
		//rs.name repair_status,

		$sql = "	SELECT 	repairo.id, repairo.ticket_number, repairo.created_at, rs.name order_status, 
					operator.name operator, client.name fname, client.last_name lname, 	 
                                        agency.name agency, brand.name brand, model.name model, service.name center,
                                        repairo.device_imei imei, repairo.device_problem detail
					FROM repair_order repairo
                                                INNER JOIN device_brand brand ON (brand.id = repairo.device_brand_id)
						INNER JOIN device_model model ON (model.id = repairo.device_model_id)
						INNER JOIN repair_status rs ON (rs.id = repairo.repair_status_id)
						INNER JOIN service_center service ON (repairo.service_center_id = service.id) 
						INNER JOIN operator ON (repairo.operator_id = operator.id)
						INNER JOIN agency ON (repairo.agency_id = agency.id)
						INNER JOIN client ON (repairo.client_id = client.id)
					WHERE repairo.enabled = 1
                    AND rs.name = 'PENDIENTE POR REPUESTO'					 													
					{$strFilter}
					ORDER BY repairo.id";
					//AND rs.name IN ('EN REPARACION', 'CONTROL DE CALIDAD', 'PENDIENTE POR REPUESTO', 'PENDIENTE CONFIRMACION DE COSTO', 'CONTROL DE CALIDAD TECNICO' )
					
		//print $sql;die;  
            $stmt = $this->getEntityManager()->getConnection()->prepare($sql);
	    $stmt->execute();
		
	    $execute = $stmt->fetchAll();		   

            return $execute;		
			
		

            
	}
	
	public function filterOutDateOrders($request){
	
		$strFilter = $this->filter($request);
				
		//default ordenes en estado ingreso
		//ros.repair_status_id order_status
		//rs.name repair_status,

		$sql = "	SELECT 	repairo.id, repairo.ticket_number, repairo.device_imei imei, repairo.created_at, 
							repairo.estimated_delivery_date delivery_date, 
							agency.name agency, brand.name brand, model.name model, rs.name order_status, service.name center

					FROM repair_order repairo

						INNER JOIN device_brand brand ON (brand.id = repairo.device_brand_id)
						INNER JOIN device_model model ON (model.id = repairo.device_model_id)
						INNER JOIN repair_status rs ON (rs.id = repairo.repair_status_id)
						INNER JOIN service_center service ON (repairo.service_center_id = service.id) 
						INNER JOIN operator ON (repairo.operator_id = operator.id)
						INNER JOIN agency ON (repairo.agency_id = agency.id)
						
					WHERE repairo.enabled = 1
					AND rs.name IN ('INGRESADO', 'EN REPARACION', 'CONTROL DE CALIDAD', 'PENDIENTE POR REPUESTO', 'PENDIENTE CONFIRMACION DE COSTO', 'CONTROL DE CALIDAD TECNICO' ) 													
					{$strFilter}
					AND NOW() > DATE(repairo.estimated_delivery_date) 
					ORDER BY repairo.id";						
					
		//print $sql;die;  
		$stmt = $this->getEntityManager()->getConnection()->prepare($sql);
	    $stmt->execute();
		
	    $execute = $stmt->fetchAll();		   

        return $execute;		
            
	}	
	
	
	public function filterResponseTimeOrders($request){
		//DATEDIFF(CURDATE(), '2015-04-18').
		
		$strFilter = "";
		if(isset($request["filter_operator"]) && $request["filter_operator"] != 0){
			$strFilter .= " AND operator.id = ".$request["filter_operator"];
		}
		
		if(isset($request["filter_brand"]) && $request["filter_brand"] != 0){
			$strFilter .= " AND brand.id = ".$request["filter_brand"];
		}
		
		if(isset($request["filter_agency"]) && $request["filter_agency"] != 0){
			$strFilter .= " AND agency.id = ".$request["filter_agency"];
		}
		if(isset($request["filter_service_center"]) && $request["filter_service_center"] != 0){
			$strFilter .= " AND service.id = ".$request["filter_service_center"];
		}						
				
		//default ordenes en estado ingreso
		//ros.repair_status_id order_status
		//rs.name repair_status,

		$sql = "	SELECT 	DISTINCT(repairo.id), DATEDIFF(DATE(ros.created_at), DATE(repairo.created_at) ) days, MONTH(repairo.created_at) monthValue

					FROM repair_order repairo

						INNER JOIN device_brand brand ON (brand.id = repairo.device_brand_id)
						INNER JOIN device_model model ON (model.id = repairo.device_model_id)
						INNER JOIN repair_status rs ON (rs.id = repairo.repair_status_id)
						INNER JOIN service_center service ON (repairo.service_center_id = service.id) 
						INNER JOIN operator ON (repairo.operator_id = operator.id)
						INNER JOIN agency ON (repairo.agency_id = agency.id)
						INNER JOIN repair_order_status ros ON (ros.repair_order_id = repairo.id)
						
					WHERE repairo.enabled = 1
					{$strFilter}
					AND YEAR(repairo.created_at) = '".$request["select_year"]."' 
					AND ros.repair_status_id IN (10,11)
					
					";
					//10 estado finalizado
					
		//print $sql;die;  
		$stmt = $this->getEntityManager()->getConnection()->prepare($sql);
	    $stmt->execute();
		
	    $execute = $stmt->fetchAll();	
	    /*
	    print "<pre>";
	    var_dump($execute);die;
		 * 
		 */
	    
	    $arrReturn = array();
	    $arrTotalByDays = array();
	    for ($i=0; $i <= 12 ; $i++) { 
			$arrReturn[$i] = array();
			for ($x=0; $x <= 8; $x++) { 
				$arrReturn[$i][$x] = 0;
				$arrTotalByDays[$x] = 0;
			}
		}
		
	    //print "<pre>";
	    foreach ($execute as $row) {
			//var_dump($row);die;
			$mes = $row["monthValue"];
			$days = $row["days"];

			if($days > 7 ){
				$arrReturn[$mes][8] = $arrReturn[$mes][8] + 1;
				$arrTotalByDays[8] = $arrTotalByDays[8] + 1; 
			}else{
				$arrReturn[$mes][$days] = $arrReturn[$mes][$days] + 1;
				$arrTotalByDays[$days] = $arrTotalByDays[$days] + 1;					
			}
							
			
		}	   
		
		array_push($arrReturn, $arrTotalByDays);
        return $arrReturn;		
		
	}
	
	

	public function filterTechWork($request){
	
		$strFilter = $this->filter($request);
				
		//default ordenes en estado ingreso
		//ros.repair_status_id order_status
		//rs.name repair_status,
		
		
		$arrReturn = array();
		//ORDENES REPARADAS = 10 = FINALIZADO
		$sql = $this->techWorkSQL(" AND ros.repair_status_id = 10 ", $strFilter);					
		//
		//print $sql;die;  
		$stmt = $this->getEntityManager()->getConnection()->prepare($sql);
	    $stmt->execute();
		
	    $execute = $stmt->fetchAll();	
		
		foreach ($execute as $key => $value) {
			
			if(!isset($arrReturn[$value["techID"]])){
				$arrReturn[$value["techID"]] = array();
				$arrReturn[$value["techID"]]["user"] = $value["tech"];
			}
			
			$arrReturn[$value["techID"]]["fixed"] = intval($value["ordersCount"]);
			
		}
		
		///////////////////////////////////////////////////////////////////////////////////////////
		//ORDENES PENDIENTES = 10 = FINALIZADO
		//IN ('EN REPARACION', 'CONTROL DE CALIDAD', 'PENDIENTE POR REPUESTO', 'PENDIENTE CONFIRMACION DE COSTO', 'CONTROL DE CALIDAD TECNICO' )
		$sql = $this->techWorkSQL(" AND ros.repair_status_id IN(3, 5, 6, 7, 12)  AND repairo.repair_status_id NOT IN(10, 11, 13) " , $strFilter);					
		//
		//print $sql;die;  
		$stmt = $this->getEntityManager()->getConnection()->prepare($sql);
	    $stmt->execute();
		
	    $execute = $stmt->fetchAll();	
		
		foreach ($execute as $key => $value) {
			
			if(!isset($arrReturn[$value["techID"]])){
				$arrReturn[$value["techID"]] = array();
				$arrReturn[$value["techID"]]["user"] = $value["tech"];
			}
			
			$arrReturn[$value["techID"]]["pending"] = intval($value["ordersCount"]);
			
		}		
		
		/*
		print "<pre>";
		var_dump($arrReturn);die;*/		
		//////////////////////////////////////////////////////////////////////////////////////////
			   
		//ORDENES DIAGNOSTICADAS = 9, 14 = NO REPARADO NO CONFIRMADO, CAMBIO POR GARANTIA
		$sql = $this->techWorkSQL(" AND ros.repair_status_id IN(9,14) ", $strFilter);					
		//
		//print $sql;die;  
		$stmt = $this->getEntityManager()->getConnection()->prepare($sql);
	    $stmt->execute();
		
	    $execute = $stmt->fetchAll();	
		
		foreach ($execute as $key => $value) {
			
			if(!isset($arrReturn[$value["techID"]])){
				$arrReturn[$value["techID"]] = array();
				$arrReturn[$value["techID"]]["user"] = $value["tech"];
			}
			
			$arrReturn[$value["techID"]]["diagnosed"] = intval($value["ordersCount"]);
			
		}
		
		//////////////////////////////////////////////////////////////////////////////////////////
			   
		//ORDENES IRREPARABLE = 8 = IRREPARABLE
		$sql = $this->techWorkSQL(" AND ros.repair_status_id = 8 ", $strFilter);					
		//
		//print $sql;die;  
		$stmt = $this->getEntityManager()->getConnection()->prepare($sql);
	    $stmt->execute();
		
	    $execute = $stmt->fetchAll();	
		
		foreach ($execute as $key => $value) {
			
			if(!isset($arrReturn[$value["techID"]])){
				$arrReturn[$value["techID"]] = array();
				$arrReturn[$value["techID"]]["user"] = $value["tech"];
			}
			
			$arrReturn[$value["techID"]]["unfixed"] = intval($value["ordersCount"]);
			
		}		
		
		
		return $arrReturn;
		
	}	



	public function filterTechWorkByLevel($request, $levels){
	
		$strFilter = $this->filter($request);
				
		//default ordenes en estado ingreso
		//ros.repair_status_id order_status
		//rs.name repair_status,
		
		
		$arrReturn = array();
		
		///get the fix levels
		foreach ($levels as $level) {
			$sql = $this->techWorkByLevelSQL($strFilter, $level->getId());	

			//
			//print $sql;die;  
			$stmt = $this->getEntityManager()->getConnection()->prepare($sql);
		    $stmt->execute();
			
		    $execute = $stmt->fetchAll();	
			
			foreach ($execute as $key => $value) {
				
				if(!isset($arrReturn[$value["techID"]])){
					$arrReturn[$value["techID"]] = array();
					$arrReturn[$value["techID"]]["user"] = $value["tech"];
				}
				
				$arrReturn[$value["techID"]][$level->getId()] = intval($value["ordersCount"]);
				
			}

		}		
		
		//print "<pre>";
		//var_dump($arrReturn);die;
		
		return $arrReturn;
		
	}	

	public function techWorkByLevelSQL($strFilter, $levelID){
		
		

		$sql = "	SELECT 	tech.id techID, tech.username tech, fixlevel.id levelID, fixlevel.name fixLevel, COUNT(DISTINCT(orderfixtype.id)) ordersCount

					FROM repair_order repairo
						INNER JOIN device_brand brand ON (brand.id = repairo.device_brand_id)
						INNER JOIN device_model model ON (model.id = repairo.device_model_id)
						INNER JOIN service_center service ON (repairo.service_center_id = service.id) 
						INNER JOIN operator ON (repairo.operator_id = operator.id)
						INNER JOIN agency ON (repairo.agency_id = agency.id)
						INNER JOIN repair_order_status ros ON (repairo.id = ros.repair_order_id)
						
						INNER JOIN repair_order_fix rof ON (repairo.id = rof.repair_order_id)
						INNER JOIN user tech ON (rof.assigned_to = tech.id)
						
						INNER JOIN repair_order_device_fix_type orderfixtype ON (orderfixtype.repair_order_id = rof.repair_order_id)
						INNER JOIN device_fix_type fixtype ON (orderfixtype.device_fix_type_id = fixtype.id)
						INNER JOIN device_fix_level fixlevel ON (fixtype.device_fix_level_id = fixlevel.id)
						
						
					WHERE 	repairo.enabled = 1
					AND 	fixlevel.id = {$levelID}
					{$strFilter}
					GROUP BY tech.id
					";
		//ORDER BY repairo.id
					
		//print $sql;die;					
		return $sql;
										
	}
	
	public function techWorkSQL($filterStatus, $strFilter){
		
		$sql = "	SELECT 	tech.id techID, tech.username tech,  COUNT(DISTINCT(repairo.id)) ordersCount

					FROM repair_order repairo
						INNER JOIN device_brand brand ON (brand.id = repairo.device_brand_id)
						INNER JOIN device_model model ON (model.id = repairo.device_model_id)
						INNER JOIN service_center service ON (repairo.service_center_id = service.id) 
						INNER JOIN operator ON (repairo.operator_id = operator.id)
						INNER JOIN agency ON (repairo.agency_id = agency.id)
						INNER JOIN repair_order_status ros ON (repairo.id = ros.repair_order_id)
						
						INNER JOIN repair_order_fix rof ON (repairo.id = rof.repair_order_id)
						INNER JOIN user tech ON (rof.assigned_to = tech.id)
						
					WHERE repairo.enabled = 1
					{$filterStatus} 													
					{$strFilter}
					GROUP BY techID
					";
		            //ORDER BY repairo.id
					
		//print $sql;die;					
		return $sql;
										
	}
	


	public function reEntryRepairmentByTech($request){
	
		$strFilter = $this->filter($request);
						
		
		$arrReturn = array();
		
		$sql = "	SELECT 	tech.username, COUNT(DISTINCT(repairo.id)) fix, COUNT(CASE WHEN qa.quality_approved = 0 THEN 1 END) returnQA 

					FROM repair_order repairo
						INNER JOIN device_brand brand ON (brand.id = repairo.device_brand_id)
						INNER JOIN device_model model ON (model.id = repairo.device_model_id)
						INNER JOIN service_center service ON (repairo.service_center_id = service.id) 
						INNER JOIN operator ON (repairo.operator_id = operator.id)
						INNER JOIN agency ON (repairo.agency_id = agency.id)
						
						INNER JOIN repair_order_fix rof ON (repairo.id = rof.repair_order_id)
						INNER JOIN user tech ON (rof.assigned_to = tech.id)
						
						LEFT JOIN repair_order_quality_control qa ON (repairo.id = qa.repair_order_id)
						
					WHERE repairo.enabled = 1
					
					{$strFilter}
					GROUP BY tech.id
					ORDER BY tech.username";
					//AND ros.repair_status_id = 10	
					
		//print $sql;die;					
							
		//
		//print $sql;die;  
		$stmt = $this->getEntityManager()->getConnection()->prepare($sql);
	    $stmt->execute();
		
	    $execute = $stmt->fetchAll();	
		
		return $execute;		
		
		
	}

	
	public function reEntryByUser($request){
	
		$strFilter = $this->filter($request);
						
		
		$arrReturn = array();
		
		$sql = "	SELECT 	u.username, COUNT(CASE WHEN qa.quality_approved = 0 THEN 1 END) returnQA 

					FROM repair_order repairo
						INNER JOIN device_brand brand ON (brand.id = repairo.device_brand_id)
						INNER JOIN device_model model ON (model.id = repairo.device_model_id)
						INNER JOIN service_center service ON (repairo.service_center_id = service.id) 
						INNER JOIN operator ON (repairo.operator_id = operator.id)
						INNER JOIN agency ON (repairo.agency_id = agency.id)
						
						INNER JOIN repair_order_fix rof ON (repairo.id = rof.repair_order_id)
						LEFT JOIN repair_order_quality_control qa ON (repairo.id = qa.repair_order_id)
						INNER JOIN user u ON (qa.created_by = u.id)
						
					WHERE repairo.enabled = 1
					
					{$strFilter}
					GROUP BY u.id
					ORDER BY u.username";
					//AND ros.repair_status_id = 10	
					
		//print $sql;die;					
							
		//
		//print $sql;die;  
		$stmt = $this->getEntityManager()->getConnection()->prepare($sql);
	    $stmt->execute();
		
	    $execute = $stmt->fetchAll();	
		
		return $execute;		
		
		
	}
			

			
	public function consolidatedReport($request){
	
		$strFilter = $this->filter($request);
						
		
		$arrReturn = array();

		
		$sql = "	SELECT DISTINCT(repairo.id), repairo.ticket_number ticketNumber, entryType.name entryType, operator.name operator, agency.name agency,
						CONCAT(client.name, ' ', client.last_name) clientName, client.phone clientPhone, client.dpi clientDpi, client.nit clientNit,
						client.contact_phone clientContactPhone, client.email clientEmail,
						brand.id brand_id, brand.name brand, model.name model, repairo.device_plan, repairo.device_imei, repairo.device_imei2, repairo.device_imei_out, repairo.device_imei2_out,  
						repairo.device_msn, repairo.device_xcvr, repairo.device_code_fab, repairo.device_problem, repairo.device_observation, repairo.device_borrowed_imei,
						repairo.device_purchase_date, repairo.entry_date, repairo.estimated_delivery_date, repairo.created_at, ruser.username created_by, repairo.invoice_number, repairo.device_msn_out serial_number_out,
						repairo.humidity, rstatus.name rStatus,
						repairo.device_change_imei, repairo.guide_in, repairo.guide_out,
						rof.fix_detail, rof.has_warranty, rof.warranty_comment, rof.fixing_price, rof.imei_new_device_change,
						assign.username assignedBy , tech.username assignedTo, rof.is_storehouse, rof.requisition_number,
						tech.username techCode, CONCAT(tech.name, ' ', tech.last_name) techName,
						service.name service,
						color.name device_color,
						
						repairo.phone_number phoneNumber,
						CONCAT(pfc.name, ' ', pfc.code) problem_found_code,
						CONCAT(arc.name, ' ', arc.code) action_reason_code,
						CONCAT(tc.description, ' ', tc.transaction_code) transaction_code,
						rof.software_out
					
						
						
					FROM repair_order repairo
						
						LEFT JOIN repair_order_fix rof ON (repairo.id = rof.repair_order_id)
						LEFT JOIN user tech ON (rof.assigned_to = tech.id)
						INNER JOIN repair_status rstatus ON (rstatus.id = repairo.repair_status_id)
						
						INNER JOIN device_brand brand ON (brand.id = repairo.device_brand_id)
						INNER JOIN device_model model ON (model.id = repairo.device_model_id)
						INNER JOIN operator ON (repairo.operator_id = operator.id)
						INNER JOIN agency ON (repairo.agency_id = agency.id)
						INNER JOIN service_center service ON (repairo.service_center_id = service.id)
						INNER JOIN device_color color ON (color.id = repairo.device_color_id)
						
						INNER JOIN client ON (client.id = repairo.client_id)
						INNER JOIN user ruser ON (repairo.created_by = ruser.id)
						
						LEFT JOIN user assign ON (assign.id = rof.assigned_by)
						INNER JOIN repair_entry_type entryType ON (entryType.id = repairo.repair_entry_type_id)
						LEFT JOIN problem_found_code pfc ON (pfc.id = rof.problem_found_code_id)
						LEFT JOIN action_reason_code arc ON (arc.id = rof.action_reason_code_id)
						LEFT JOIN transaction_code tc ON (tc.id = rof.transaction_code_id)
						
												
					WHERE repairo.enabled = 1
					{$strFilter}
					ORDER BY repairo.id";	
					
					
					
		
		//print "<pre>";			
		//print $sql;die;					
							
		//
		//print $sql;die;  
		$stmt = $this->getEntityManager()->getConnection()->prepare($sql);
	    $stmt->execute();
		
	    $execute = $stmt->fetchAll();
	    $arrReturn = array();
	    $em = $this->getEntityManager();
	    
	    
	    foreach ($execute as $key => $value) {
			$arrReturn[$key] = array();	
			
			$orderID = intval($value["id"]);
			
			//getHistoryLog
			$repairOrderHistory = $em->getRepository('SolucelAdminBundle:RepairOrder')->getOrderHistory($orderID);
			//print "<pre>";
			//var_dump($repairOrderHistory);die;
			$value["historyLog"] = "";
			foreach ($repairOrderHistory as $historyKey => $historyValue) {
				$value["historyLog"] .= $historyValue["status"]." ".$historyValue["created_at"].";";
			}
			$this->getEntityManager()->flush();
			$this->getEntityManager()->clear();
			
			
			//getReplacementLog
			//$replacements = $em->getRepository('SolucelAdminBundle:RepairOrderDeviceReplacement')->findByRepairOrder($orderID);
			$replacements = $em->getRepository('SolucelAdminBundle:RepairOrder')->getReplacementsByRepairOrder($orderID);
			//print "<pre>";
			//var_dump($repairOrderHistory);die;
			$value["replacements"] = array();
            $value["replacementsCodes"] = array();
			if($replacements){
				//print "entra replacements";die;
				//$replacements = $replacements[0];
				
				foreach ($replacements as $replacement) {
					if($replacement){
						$value["replacements"][] = $replacement["name"];
                        $value["replacementsCodes"][] = $replacement["replacement_code"];
                        //$replacement["replacement_code"].",".$replacement["strdatabase"]."; ";
					}
					
				}	
				$this->getEntityManager()->flush();
				$this->getEntityManager()->clear();
		
				
			}
			
			
			//getFixLevelLog
			$fixLevels = $em->getRepository('SolucelAdminBundle:RepairOrder')->getFixTypeByRepairOrder($orderID);
			//print "<pre>";
			//var_dump($repairOrderHistory);die;
			$value["fixLevelLog"] = "";
            $value["mainRepairment"] = "";
            $value["mainRepairmentLevel"] = "";
			if($fixLevels){

				foreach ($fixLevels as $fix) {
					if($fix){
						$value["fixLevelLog"] .= $fix["name"].", Nivel ".$fix["level"]."; ";
                        $value["mainRepairment"] .= $fix["name"];
                        $value["mainRepairmentLevel"] .= $fix["level"];
					}
					
				}	
				$this->getEntityManager()->flush();
				$this->getEntityManager()->clear();
		
				
			}	
			
			//var_dump($value["fixLevelLog"]);die;		
			
			//getAddFields
			$fields = $em->getRepository('SolucelAdminBundle:RepairOrder')->getAddFieldByRepairOrder($orderID);
			//print "<pre>";
			//var_dump($repairOrderHistory);die;
			$value["fields"] = "";
			if($fields){
				
				
				foreach ($fields as $field) {
					$value["fields"] .= $field["name"].":".$field["value"]." / ";
				}	
				$this->getEntityManager()->flush();
				$this->getEntityManager()->clear();
		
				
			}			
			
			//getQualityInfo
			$qualityInfo = $em->getRepository('SolucelAdminBundle:RepairOrder')->getQualityControlByRepairOrder($orderID);
			//print "<pre>";
			//var_dump($repairOrderHistory);die;
			$value["quality_by"] = "";
			$value["quality_at"] = "";
			if($qualityInfo){
				//$qualityInfo = $qualityInfo[0];
				
				foreach ($qualityInfo as $q) {
					if($q){
						$value["quality_by"] .= $q["username"].",";
						$value["quality_at"] .= $q["created_at"].",";
						
					}
				}	
				$this->getEntityManager()->flush();
				$this->getEntityManager()->clear();
		
				
			}		
			
				
						
			
			//getFinishedInfo
			//$finished = $em->getRepository('SolucelAdminBundle:RepairOrderStatus')->findBy(array("repairOrder" => $orderID, "repairStatus" => 10));
			$finished = $em->getRepository('SolucelAdminBundle:RepairOrder')->getRepairStatusByRepairOrder($orderID, 10);
			//print "<pre>";
			//var_dump($repairOrderHistory);die;
			$value["finished_by"] = "";
			$value["finished_at"] = "";
			if($finished){
				
				
				foreach ($finished as $f) {
					if($f){
						$value["finished_by"] .= $f["username"].",";
						$value["finished_at"] .= $f["created_at"].",";
						
					}
				}	
				$this->getEntityManager()->flush();
				$this->getEntityManager()->clear();
		
				
			}
			
			
						
			//getDeliveryInfo
			//$delivery = $em->getRepository('SolucelAdminBundle:RepairOrderStatus')->findBy(array("repairOrder" => $orderID, "repairStatus" => 11));
			$delivery = $em->getRepository('SolucelAdminBundle:RepairOrder')->getRepairStatusByRepairOrder($orderID,11);
			//print "<pre>";
			//var_dump($repairOrderHistory);die;
			$value["delivered_by"] = "";
			$value["delivered_at"] = "";
			if($delivery){
				
				
				foreach ($delivery as $f) {
					if($f){
						$value["delivered_by"] .= $f["username"].",";
						$value["delivered_at"] .= $f["created_at"].",";
						
					}
				}	
				$this->getEntityManager()->flush();
				$this->getEntityManager()->clear();
		
				
			}		


			//getRepairmentInfo
			//$repairment = $em->getRepository('SolucelAdminBundle:RepairOrderStatus')->findBy(array("repairOrder" => $orderID, "repairStatus" => 3));
			/*$repairment = $em->getRepository('SolucelAdminBundle:RepairOrder')->getRepairStatusByRepairOrder($orderID, 3);*/
			//getRepairStatusByRepairOrder
			//print "<pre>";
			//var_dump($repairOrderHistory);die;
            /*
			$value["repaired_at"] = "";
			if($repairment){
				
				
				foreach ($repairment as $f) {
					if($f){
						$value["repaired_at"] .= $f["created_at"].",";	
					}
					
				}		
				$this->getEntityManager()->flush();
				$this->getEntityManager()->clear();
	
				
			}
            */

            //getLastRepairmentDate
            $repairmentDate = $em->getRepository('SolucelAdminBundle:RepairOrder')->getLastRepairmentDate($orderID, 3);
            $value["repaired_at"] = "";
            if(isset($repairmentDate[0])){
                //var_dump($repairmentDate);die;
                $repairmentDate = $repairmentDate[0]["created_at"];
                $value["repaired_at"] = $repairmentDate;
            }

            $this->getEntityManager()->flush();
            $this->getEntityManager()->clear();


			
			//getAccesories
			$accessories = $em->getRepository('SolucelAdminBundle:RepairOrder')->getAccessoryByRepairOrder($orderID);
			//print "<pre>";
			//var_dump($repairOrderHistory);die;
			$value["accesories"] = "";
			if($accessories){
				
				foreach ($accessories as $a) {
					if($a){
						$value["accesories"] .= $a["name"].":".$a["description"]." / ";
					}
						
				}	
				$this->getEntityManager()->flush();
				$this->getEntityManager()->clear();
		
				
			}			
			
			//getDefectCode
			$defectCodes = $em->getRepository('SolucelAdminBundle:RepairOrder')->getDefectByRepairOrder($orderID);
			//print "<pre>";
			//var_dump($repairOrderHistory);die;
            $value["defects"] = "";
            $value["arrDefects"] = array();
            $value["defectType"] = "";


			if($defectCodes){

				foreach ($defectCodes as $d) {

					$code = "00";					
					$objCode = $em->getRepository('SolucelAdminBundle:DeviceDefectCode')->findBy(array("deviceDefect" => $d["id"], "deviceBrand" => $value["brand_id"]));
					if($objCode){
						$objCode = $objCode[0];
						$code = $objCode->getDefectCode();
					}

					$tempDefect = $d["name"].":".$d["defect_type"].", ".$code." / ";
					$value["defects"] .=  $value["defects"] != "" ? ",".$tempDefect : $tempDefect;

					$tempDefectType = $d["defect_type"];
                    $value["defectType"] .= $value["defectType"] != "" ? ",".$tempDefectType : $tempDefectType;


                    $value["arrDefects"][] = $d["name"];
				}		
				$this->getEntityManager()->flush();
				$this->getEntityManager()->clear();
	
				
			}


            //getDefectCode
            $defectCodes = $em->getRepository('SolucelAdminBundle:RepairOrder')->getDefectByRepairOrder($orderID);
            //print "<pre>";
            //var_dump($repairOrderHistory);die;

            $strDefectType = "";

            if($defectCodes){

                foreach ($defectCodes as $d) {

                    $code = "00";
                    $objCode = $em->getRepository('SolucelAdminBundle:DeviceDefectCode')->findBy(array("deviceDefect" => $d["id"], "deviceBrand" => $value["brand_id"]));
                    if($objCode){
                        $objCode = $objCode[0];
                        $code = $objCode->getDefectCode();
                    }

                    //$value["defects"][] = $d["name"].":".$d["defect_type"];
                    $strDefectType = $strDefectType != "" ?  ",".$d["defect_type"] : $d["defect_type"];
                }
                $this->getEntityManager()->flush();
                $this->getEntityManager()->clear();


            }



            //getRepairmentCode
			$repairmentCodes = $em->getRepository('SolucelAdminBundle:RepairOrder')->getFixTypeByRepairOrder($orderID);
			//print "<pre>";
			//var_dump($repairOrderHistory);die;
			$value["repairments"] = "";
			if($repairmentCodes){
				
				foreach ($repairmentCodes as $d) {

					$code = "00";					
					$objCode = $em->getRepository('SolucelAdminBundle:DeviceFixTypeCode')->findBy(array("deviceFixType" => $d["id"], "deviceBrand" => $value["brand_id"]));
					if($objCode){
						$objCode = $objCode[0];
						$code = $objCode->getFixTypeCode();
					}

					$value["repairments"] .= $d["name"].":".$code." / ";
				}	
				$this->getEntityManager()->flush();
				$this->getEntityManager()->clear();
		
				
			}				
			
			//GROUP_CONCAT(device_fix_level.name SEPARATOR ', ') fixLevelLog,
			//GROUP_CONCAT( CONCAT(field.name,'=',field.value) SEPARATOR ';') fields,
			
			
			 
			 /*
			  * 
			  * 						repairStatus.created_at repairment_date,
						uquality.username quality_by, quality.created_at quality_created,
						ufinished.username finished_by, repairFinished.created_at finished_at,
						udelivery.username delivered_by, repairDelivery.created_at delivered_at
			  * 
			  * 
			  * LEFT JOIN repair_order_additional_field field ON (repairo.id = field.repair_order_id)
			 * 
			 * 						INNER JOIN repair_order_status repairStatus ON (repairStatus.repair_order_id = repairo.id AND repairStatus.repair_status_id = 3)
						LEFT JOIN repair_order_quality_control quality ON (quality.repair_order_id = repairo.id)
						LEFT JOIN user uquality ON (quality.created_by = uquality.id)
						
						LEFT JOIN repair_order_status repairFinished ON (repairFinished.repair_order_id = repairo.id AND repairFinished.repair_status_id = 10)
						LEFT JOIN user ufinished ON (repairFinished.created_by = ufinished.id)
						
						LEFT JOIN repair_order_status repairDelivery ON (repairDelivery.repair_order_id = repairo.id AND repairDelivery.repair_status_id = 11)
						LEFT JOIN user udelivery ON (repairDelivery.created_by = udelivery.id)
			 * 
			 * 						LEFT JOIN repair_order_device_replacement orderreplacement ON (orderreplacement.repair_order_id = repairo.id)
						LEFT JOIN device_replacement replacement ON (replacement.id = orderreplacement.device_replacement_id)
			  * 
			  * 						LEFT JOIN repair_order_device_fix_type fixtype ON (fixtype.repair_order_id = repairo.id)
						LEFT JOIN device_fix_type devicefixtype ON (devicefixtype.id = fixtype.device_fix_type_id)
						LEFT JOIN device_fix_level ON (device_fix_level.id = devicefixtype.device_fix_level_id)
			  * 
			 * 
			 * 
			 */
						
			$arrReturn[$key] = $value;
			
		}
		$this->getEntityManager()->flush();
		$this->getEntityManager()->clear();

	    	
		
		return $arrReturn;		
		
		
	}
	

	public function filterSales($request){
	
		$strFilter = $this->filter($request);
				
		//default ordenes en estado ingreso
		//ros.repair_status_id order_status
		//rs.name repair_status,
		
		
		$arrReturn = array();
		
		//status 10 finalizado,11 entregado,13 listo para entrega
		
		$sql = "	SELECT 	SUM(rof.fixing_price) total, service.id, service.name service

					FROM repair_order repairo
						INNER JOIN device_brand brand ON (brand.id = repairo.device_brand_id)
						INNER JOIN device_model model ON (model.id = repairo.device_model_id)
						INNER JOIN service_center service ON (repairo.service_center_id = service.id) 
						INNER JOIN operator ON (repairo.operator_id = operator.id)
						INNER JOIN agency ON (repairo.agency_id = agency.id)
						
						INNER JOIN repair_order_fix rof ON (repairo.id = rof.repair_order_id)
						
					WHERE 	repairo.enabled = 1
					AND 	repairo.repair_status_id IN(10,11,13)
					AND		rof.has_warranty = 0
					{$strFilter}
					GROUP BY service.id, service.name
					ORDER BY service.name";
					
		//print $sql;die;					
			///print $strFilter;die;	
		//print $sql;die;  
		$stmt = $this->getEntityManager()->getConnection()->prepare($sql);
	    $stmt->execute();
		
	    $execute = $stmt->fetchAll();	
			
		
		//print "<pre>";
		//var_dump($arrReturn);die;
		
		return $execute;
		
	}	


							

	public function filterEntryType($request){
	
		$strFilter = $this->filter($request);
				
		//default ordenes en estado ingreso
		//ros.repair_status_id order_status
		//rs.name repair_status,
		
		
		$arrReturn = array();
		
		//status 10 finalizado,11 entregado,13 listo para entrega
		
		$sql = "	SELECT 	SUM(ret.id) total, ret.name entryType, 
							service.name service, operator.name operator, agency.name agency,
							brand.name brand, tech.username tech 

					FROM repair_order repairo
						INNER JOIN device_brand brand ON (brand.id = repairo.device_brand_id)
						INNER JOIN device_model model ON (model.id = repairo.device_model_id)
						INNER JOIN service_center service ON (repairo.service_center_id = service.id) 
						INNER JOIN operator ON (repairo.operator_id = operator.id)
						INNER JOIN agency ON (repairo.agency_id = agency.id)
						
						INNER JOIN repair_order_fix rof ON (repairo.id = rof.repair_order_id)
						INNER JOIN repair_entry_type ret ON (repairo.repair_entry_type_id = ret.id)
						INNER JOIN user tech ON (tech.id = rof.assigned_to)
						
					WHERE 	repairo.enabled = 1
					{$strFilter}
					GROUP BY ret.id, service.id, operator.id, agency.id, brand.id, tech.id
					ORDER BY tech.id";	
					
		//print $sql;die;					
				
		//print $sql;die;  
		$stmt = $this->getEntityManager()->getConnection()->prepare($sql);
	    $stmt->execute();
		
	    $execute = $stmt->fetchAll();	
			
		
		//print "<pre>";
		//var_dump($arrReturn);die;
		
		return $execute;
		
	}	

}			
   

